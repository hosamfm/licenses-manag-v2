<!DOCTYPE html>
<html lang="ar">
<head>
  <%- include('partials/_head') %>
  <title>إعدادات الذكاء الاصطناعي</title>
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .form-section {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }
    .form-section:last-child {
      border-bottom: none;
    }
    .section-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 20px;
      color: #3c4b64;
    }
    .form-label {
      font-weight: bold;
    }
    .form-text {
      margin-top: 5px;
      font-size: 0.85rem;
    }
    .range-value {
      font-weight: bold;
      margin-left: 10px;
    }
    .btn-ai {
      background-color: #6f42c1;
      color: white;
    }
    .btn-ai:hover {
      background-color: #5a32a3;
      color: white;
    }
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    .keyword-badge {
      display: inline-block;
      background-color: #e9ecef;
      padding: 5px 10px;
      margin: 5px;
      border-radius: 15px;
    }
    .keyword-badge .remove-keyword {
      margin-right: 5px;
      cursor: pointer;
      color: #dc3545;
    }
    #transferKeywords {
      min-height: 150px;
    }
    #systemInstructions {
      min-height: 250px;
    }
    .token-counter {
      font-size: 0.85rem;
      color: #6c757d;
      text-align: left;
      margin-top: 5px;
    }
    .instructions-info {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <%- include('partials/_header') %>
  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="fas fa-robot"></i> إعدادات الذكاء الاصطناعي</h1>
      <div class="header-buttons">
        <button type="button" class="btn btn-warning" id="resetDefaults">
          <i class="fas fa-undo"></i> استعادة الإعدادات الافتراضية
        </button>
        <a href="/settings" class="btn btn-secondary">
          <i class="fas fa-arrow-right"></i> العودة لإعدادات النظام
        </a>
      </div>
    </div>

    <% if (flashMessages.error) { %>
      <div class="alert alert-danger"><%= flashMessages.error %></div>
    <% } %>
    <% if (flashMessages.success) { %>
      <div class="alert alert-success"><%= flashMessages.success %></div>
    <% } %>

    <form action="/settings/ai-detailed-settings" method="POST">
      <!-- إعدادات API -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-key"></i> إعدادات واجهة برمجة التطبيقات (API)</h2>
        <div class="row mb-3">
          <div class="col-md-8">
            <label for="apiKey" class="form-label">مفتاح API (OpenAI API Key)</label>
            <input type="password" class="form-control" id="apiKey" name="apiKey" value="<%= aiSettings.apiKey %>" required>
            <div class="form-text">مفتاح API الخاص بحساب OpenAI. هذا المفتاح ضروري لاستخدام خدمة الذكاء الاصطناعي.</div>
          </div>
          <div class="col-md-4 d-flex align-items-end">
            <button type="button" class="btn btn-outline-secondary mb-3" id="toggleApiKey">
              <i class="fas fa-eye"></i> إظهار/إخفاء المفتاح
            </button>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-8">
            <label for="apiEndpoint" class="form-label">نقطة نهاية API (API Endpoint)</label>
            <input type="text" class="form-control" id="apiEndpoint" name="apiEndpoint" value="<%= aiSettings.apiEndpoint %>" required>
            <div class="form-text">عنوان URL لواجهة برمجة التطبيقات. عادة ما يكون https://api.openai.com/v1/chat/completions</div>
          </div>
          <div class="col-md-4">
            <label for="model" class="form-label">نموذج الذكاء الاصطناعي</label>
            <select class="form-select" id="model" name="model">
              <!-- النماذج الرئيسية -->
              <optgroup label="النماذج الرئيسية (الأحدث)">
                <option value="gpt-4o" <%= aiSettings.model === 'gpt-4o' ? 'selected' : '' %>>GPT-4o (الأحدث والأكثر قدرة)</option>
                <option value="gpt-4o-mini" <%= aiSettings.model === 'gpt-4o-mini' ? 'selected' : '' %>>GPT-4o Mini (سريع وفعال)</option>
              </optgroup>
              
              <!-- النماذج المتقدمة -->
              <optgroup label="النماذج المتقدمة">
                <option value="gpt-4-turbo" <%= aiSettings.model === 'gpt-4-turbo' ? 'selected' : '' %>>GPT-4 Turbo</option>
                <option value="gpt-4-turbo-2024-04-09" <%= aiSettings.model === 'gpt-4-turbo-2024-04-09' ? 'selected' : '' %>>GPT-4 Turbo 2024-04-09</option>
                <option value="gpt-4-0125-preview" <%= aiSettings.model === 'gpt-4-0125-preview' ? 'selected' : '' %>>GPT-4 0125 Preview</option>
                <option value="gpt-4-1106-preview" <%= aiSettings.model === 'gpt-4-1106-preview' ? 'selected' : '' %>>GPT-4 1106 Preview</option>
              </optgroup>
              
              <!-- النماذج الأساسية -->
              <optgroup label="النماذج الأساسية">
                <option value="gpt-3.5-turbo" <%= aiSettings.model === 'gpt-3.5-turbo' ? 'selected' : '' %>>GPT-3.5 Turbo</option>
                <option value="gpt-3.5-turbo-0125" <%= aiSettings.model === 'gpt-3.5-turbo-0125' ? 'selected' : '' %>>GPT-3.5 Turbo 0125</option>
                <option value="gpt-3.5-turbo-1106" <%= aiSettings.model === 'gpt-3.5-turbo-1106' ? 'selected' : '' %>>GPT-3.5 Turbo 1106</option>
                <option value="gpt-3.5-turbo-instruct" <%= aiSettings.model === 'gpt-3.5-turbo-instruct' ? 'selected' : '' %>>GPT-3.5 Turbo Instruct</option>
              </optgroup>
              
              <!-- نماذج الوسائط المتعددة -->
              <optgroup label="نماذج الوسائط المتعددة">
                <option value="gpt-4-vision-preview" <%= aiSettings.model === 'gpt-4-vision-preview' ? 'selected' : '' %>>GPT-4 Vision Preview</option>
                <option value="dall-e-3" <%= aiSettings.model === 'dall-e-3' ? 'selected' : '' %>>DALL-E 3 (إنشاء صور)</option>
                <option value="dall-e-2" <%= aiSettings.model === 'dall-e-2' ? 'selected' : '' %>>DALL-E 2 (إنشاء صور)</option>
              </optgroup>
            </select>
            <div class="form-text">نموذج OpenAI المستخدم. النماذج الأحدث تكون أكثر قدرة لكن أعلى تكلفة. لاحظ أن بعض النماذج قد تتطلب ترقية حسابك لدى OpenAI.</div>
          </div>
        </div>
      </div>

      <!-- إعدادات الوسائط المتعددة -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-photo-video"></i> إعدادات الوسائط المتعددة</h2>
        <p class="text-muted">هذه الإعدادات تسمح للذكاء الاصطناعي بتحليل ومعالجة الصور والتسجيلات الصوتية التي يرسلها العملاء.</p>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="enableVisionSupport" name="enableVisionSupport" <%= aiSettings.enableVisionSupport ? 'checked' : '' %>>
              <label class="form-check-label" for="enableVisionSupport">تفعيل تحليل الصور ومقاطع الفيديو</label>
            </div>
            <div class="form-text mb-3">
              تمكين دعم تحليل الصور يسمح للذكاء الاصطناعي بفهم ووصف الصور المرسلة من العملاء. هذه الميزة تعمل فقط مع النماذج التي تدعم الرؤية مثل GPT-4o.
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="enableAudioSupport" name="enableAudioSupport" <%= aiSettings.enableAudioSupport ? 'checked' : '' %>>
              <label class="form-check-label" for="enableAudioSupport">تفعيل تحليل التسجيلات الصوتية</label>
            </div>
            <div class="form-text mb-3">
              تمكين دعم تحليل الصوت يسمح للذكاء الاصطناعي بتحويل الرسائل الصوتية إلى نص، ومن ثم الرد عليها.
            </div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="audioToTextModel" class="form-label">نموذج تحويل الصوت إلى نص</label>
            <select class="form-select" id="audioToTextModel" name="audioToTextModel">
              <option value="whisper-1" <%= aiSettings.audioToTextModel === 'whisper-1' ? 'selected' : '' %>>Whisper-1 (المتوازن)</option>
              <option value="whisper-2" <%= aiSettings.audioToTextModel === 'whisper-2' ? 'selected' : '' %>>Whisper-2 (الأحدث والأدق)</option>
            </select>
            <div class="form-text">نموذج Whisper المستخدم لتحويل الصوت إلى نص. النماذج الأحدث تكون أكثر دقة.</div>
          </div>
          
          <div class="col-md-6">
            <label for="textToSpeechModel" class="form-label">نموذج تحويل النص إلى صوت</label>
            <select class="form-select" id="textToSpeechModel" name="textToSpeechModel">
              <option value="tts-1" <%= aiSettings.textToSpeechModel === 'tts-1' ? 'selected' : '' %>>TTS-1 (الأساسي)</option>
              <option value="tts-1-hd" <%= aiSettings.textToSpeechModel === 'tts-1-hd' ? 'selected' : '' %>>TTS-1-HD (جودة عالية)</option>
            </select>
            <div class="form-text">نموذج تحويل النص إلى صوت للرد على العملاء بتسجيلات صوتية عند الحاجة.</div>
          </div>
        </div>
      </div>

      <!-- إعدادات الجودة -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-sliders-h"></i> إعدادات جودة وأداء النماذج</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="temperature" class="form-label">درجة الإبداعية (Temperature)</label>
            <input type="range" class="form-range" id="temperature" name="temperature" min="0" max="2" step="0.1" value="<%= aiSettings.temperature %>">
            <div class="d-flex justify-content-between">
              <div>0 (أكثر دقة)</div>
              <div id="temperatureValue"><%= aiSettings.temperature %></div>
              <div>2 (أكثر إبداعًا)</div>
            </div>
            <div class="form-text">تؤثر على تنوع وإبداعية الردود. القيم المنخفضة تجعل الردود أكثر تركيزًا ودقة، بينما القيم العالية تزيد من الإبداعية والتنوع.</div>
          </div>
          <div class="col-md-6">
            <label for="maxTokens" class="form-label">الحد الأقصى للتوكنز (Max Tokens)</label>
            <input type="range" class="form-range" id="maxTokens" name="maxTokens" min="100" max="4000" step="50" value="<%= aiSettings.maxTokens %>">
            <div class="d-flex justify-content-between">
              <div>100</div>
              <div id="maxTokensValue"><%= aiSettings.maxTokens %></div>
              <div>4000</div>
            </div>
            <div class="form-text">الحد الأقصى لعدد التوكنز (وحدات النص) التي يمكن للنموذج إنتاجها في الرد الواحد. التوكن الواحد يعادل تقريباً ¾ كلمة.</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="topP" class="form-label">التركيز النسبي (Top P)</label>
            <input type="range" class="form-range" id="topP" name="topP" min="0" max="1" step="0.05" value="<%= aiSettings.topP %>">
            <div class="d-flex justify-content-between">
              <div>0 (أكثر تركيزًا)</div>
              <div id="topPValue"><%= aiSettings.topP %></div>
              <div>1</div>
            </div>
            <div class="form-text">تقنية أخرى للتحكم في تنوع النص، حيث يختار النموذج من مجموعة الاحتمالات الأعلى. القيم المنخفضة تنتج نصوصًا أكثر تركيزًا.</div>
          </div>
          <div class="col-md-6">
            <label for="seed" class="form-label">بذرة عشوائية (Seed)</label>
            <input type="number" class="form-control" id="seed" name="seed" min="0" max="9999999" step="1" value="<%= aiSettings.seed !== null ? aiSettings.seed : '' %>" placeholder="تركه فارغًا = عشوائي">
            <div class="form-text">رقم تحكم للحصول على نتائج متسقة عند استخدام نفس المدخلات. اتركها فارغة للحصول على ردود متنوعة.</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="presencePenalty" class="form-label">معامل عقوبة التكرار (Presence Penalty)</label>
            <input type="range" class="form-range" id="presencePenalty" name="presencePenalty" min="-2" max="2" step="0.1" value="<%= aiSettings.presencePenalty %>">
            <div class="d-flex justify-content-between">
              <div>-2</div>
              <div id="presencePenaltyValue"><%= aiSettings.presencePenalty %></div>
              <div>2</div>
            </div>
            <div class="form-text">يؤثر على احتمالية تكرار المواضيع. القيم الموجبة تقلل من تكرار المواضيع التي ظهرت بالفعل.</div>
          </div>
          <div class="col-md-6">
            <label for="frequencyPenalty" class="form-label">معامل عقوبة تكرار الكلمات (Frequency Penalty)</label>
            <input type="range" class="form-range" id="frequencyPenalty" name="frequencyPenalty" min="-2" max="2" step="0.1" value="<%= aiSettings.frequencyPenalty %>">
            <div class="d-flex justify-content-between">
              <div>-2</div>
              <div id="frequencyPenaltyValue"><%= aiSettings.frequencyPenalty %></div>
              <div>2</div>
            </div>
            <div class="form-text">يؤثر على احتمالية تكرار نفس الكلمات. القيم الموجبة تقلل من تكرار الكلمات.</div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="responseFormat" class="form-label">تنسيق الاستجابة (Response Format)</label>
            <select class="form-select" id="responseFormat" name="responseFormat">
              <option value="" <%= !aiSettings.responseFormat ? 'selected' : '' %>>النص العادي (الافتراضي)</option>
              <option value="text" <%= aiSettings.responseFormat === 'text' ? 'selected' : '' %>>نص عادي (Text)</option>
              <option value="json_object" <%= aiSettings.responseFormat === 'json_object' ? 'selected' : '' %>>كائن JSON (JSON Object)</option>
            </select>
            <div class="form-text">تنسيق الرد المطلوب من النموذج. استخدم JSON للتطبيقات التي تحتاج إلى بيانات مهيكلة.</div>
          </div>
          <div class="col-md-6">
            <label for="userIdentifier" class="form-label">معرف المستخدم (User Identifier)</label>
            <input type="text" class="form-control" id="userIdentifier" name="userIdentifier" value="<%= aiSettings.userIdentifier || '' %>" placeholder="معرف خاص بنظامك">
            <div class="form-text">معرف اختياري للمستخدم النهائي يساعد OpenAI في مراقبة وكشف إساءة الاستخدام.</div>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="stream" name="stream" <%= aiSettings.stream ? 'checked' : '' %>>
              <label class="form-check-label" for="stream">تفعيل تدفق الاستجابة (Streaming)</label>
            </div>
            <div class="form-text">عند تفعيله، سيتم استلام الرد من النموذج تدريجيًا أثناء إنشائه بدلاً من انتظار الرد الكامل.</div>
          </div>
        </div>
      </div>

      <!-- إعدادات السياق -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-history"></i> إعدادات السياق والتاريخ</h2>
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="conversationHistoryLimit" class="form-label">حد تاريخ المحادثة الحالية: <span id="conversationHistoryLimitValue" class="range-value"><%= aiSettings.conversationHistoryLimit %></span></label>
            <input type="range" class="form-range" id="conversationHistoryLimit" name="conversationHistoryLimit" min="5" max="50" step="1" value="<%= aiSettings.conversationHistoryLimit %>">
            <div class="form-text">عدد الرسائل السابقة التي سيتذكرها الذكاء الاصطناعي في المحادثة الحالية. القيمة الأعلى تحسن السياق لكن تزيد التكلفة.</div>
          </div>
          <div class="col-md-6">
            <label for="previousConversationsLimit" class="form-label">حد المحادثات السابقة: <span id="previousConversationsLimitValue" class="range-value"><%= aiSettings.previousConversationsLimit %></span></label>
            <input type="range" class="form-range" id="previousConversationsLimit" name="previousConversationsLimit" min="0" max="10" step="1" value="<%= aiSettings.previousConversationsLimit %>">
            <div class="form-text">عدد المحادثات السابقة المكتملة التي سيتم تزويد الذكاء الاصطناعي بملخص عنها. القيمة 0 تعني تجاهل المحادثات السابقة.</div>
          </div>
        </div>
      </div>

      <!-- إعدادات رسالة الترحيب -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-hand-sparkles"></i> إعدادات رسالة الترحيب الأولية</h2>
        <p class="text-muted">تخصيص رسالة الترحيب التي يتم إرسالها تلقائيًا عند بدء محادثة جديدة.</p>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <label for="greetingPrompt" class="form-label">نص التوجيه لإنشاء الترحيب (Prompt)</label>
            <textarea class="form-control" id="greetingPrompt" name="greetingPrompt" rows="6"><%= aiSettings.greetingPrompt || '' %></textarea>
            <div class="form-text">اكتب التعليمات التي سيتبعها الذكاء الاصطناعي لإنشاء رسالة الترحيب. يمكنك استخدام متغيرات مثل `{customerName}` إذا أردت تضمين اسم العميل (سيتم استبداله بالاسم الأول).</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label for="greetingModel" class="form-label">النموذج المستخدم للترحيب</label>
            <select class="form-select" id="greetingModel" name="greetingModel">
              <option value="gpt-3.5-turbo" <%= aiSettings.greetingModel === 'gpt-3.5-turbo' ? 'selected' : '' %>>GPT-3.5 Turbo (أسرع وأقل تكلفة)</option>
              <option value="gpt-4o-mini" <%= aiSettings.greetingModel === 'gpt-4o-mini' ? 'selected' : '' %>>GPT-4o Mini</option>
              <option value="gpt-4o" <%= aiSettings.greetingModel === 'gpt-4o' ? 'selected' : '' %>>GPT-4o</option>
              <!-- يمكنك إضافة نماذج أخرى إذا لزم الأمر -->
            </select>
            <div class="form-text">اختر نموذج الذكاء الاصطناعي لإنشاء رسالة الترحيب. النماذج الأبسط تكون كافية غالبًا وأقل تكلفة.</div>
          </div>
          <div class="col-md-6">
            <label for="greetingTemperature" class="form-label">درجة إبداعية الترحيب (Temperature)</label>
            <input type="range" class="form-range" id="greetingTemperature" name="greetingTemperature" min="0" max="2" step="0.1" value="<%= aiSettings.greetingTemperature || 0.8 %>">
            <div class="d-flex justify-content-between">
              <div>0 (أكثر دقة)</div>
              <div id="greetingTemperatureValue"><%= aiSettings.greetingTemperature || 0.8 %></div>
              <div>2 (أكثر إبداعًا)</div>
            </div>
            <div class="form-text">تتحكم في مدى إبداعية رسالة الترحيب. القيم الأعلى تجعلها ودودة أكثر.</div>
          </div>
        </div>
      </div>
      
      <!-- كلمات التحويل للمندوب البشري -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-exchange-alt"></i> كلمات التحويل للمندوب البشري</h2>
        <p class="text-muted">عند اكتشاف أي من هذه الكلمات أو العبارات في رسالة العميل، سيتم تحويل المحادثة تلقائياً إلى مندوب بشري.</p>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <div class="instructions-info">
              <p><i class="fas fa-info-circle"></i> <strong>تعليمات:</strong> أضف كلمات أو عبارات منفصلة بسطور جديدة. عندما يكتب العميل إحدى هذه العبارات، سيتم تحويله لمندوب بشري.</p>
            </div>
            <textarea class="form-control" id="transferKeywords" name="transferKeywords" rows="8"><%= aiSettings.transferKeywords.join('\n') %></textarea>
            <div class="form-text">
              أمثلة: "أريد التحدث مع شخص"، "تحويل إلى موظف"، "مشكلة معقدة"، إلخ.
              <br>
              <strong>ملاحظة:</strong> اكتب كل كلمة أو عبارة في سطر منفصل.
            </div>
          </div>
        </div>
      </div>

      <!-- تعليمات تحويل المحادثات إلى المندوبين -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-random"></i> تعليمات تحويل المحادثات</h2>
        <p class="text-muted">حدد التعليمات التي سيتبعها الذكاء الاصطناعي عند التعامل مع طلبات تحويل المحادثة إلى المندوبين البشريين.</p>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <div class="instructions-info">
              <p><i class="fas fa-info-circle"></i> <strong>تعليمات:</strong> أضف تعليمات تفصيلية حول كيفية تعامل الذكاء الاصطناعي مع طلبات التحويل للمندوبين البشريين.</p>
            </div>
            <textarea class="form-control" id="transferInstructions" name="transferInstructions" rows="8"><%= aiSettings.transferInstructions || '' %></textarea>
            <div class="form-text">
              هذه التعليمات تستخدم لتوجيه الذكاء الاصطناعي حول كيفية التعامل مع طلبات التحويل. <strong>يرجى إضافة تعليمات مفصلة هنا</strong> لأن النظام لا يستخدم أي تعليمات افتراضية. تأكد من شرح عملية استخدام علامة [تحويل:اسم_المندوب] وأي خطوات أخرى ضرورية لعملية التحويل.
            </div>
          </div>
        </div>
      </div>

      <!-- تعليمات النظام للذكاء الاصطناعي -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-brain"></i> تعليمات النظام للذكاء الاصطناعي</h2>
        
        <div class="instructions-info">
          <p><strong>ماذا تعني تعليمات النظام؟</strong></p>
          <p>تعليمات النظام هي التوجيهات الرئيسية للذكاء الاصطناعي التي تحدد كيفية تصرفه وطبيعة ردوده على العملاء. يمكنك تعديل هذه التعليمات لتخصيص طريقة تعامل الذكاء الاصطناعي مع العملاء.</p>
          <p><strong>نصائح لكتابة تعليمات فعالة:</strong></p>
          <ul>
            <li>حدد هوية المساعد الآلي بوضوح (الاسم والدور)</li>
            <li>اشرح طبيعة اللغة والأسلوب المتوقع استخدامه</li>
            <li>وضح السياق والقيود المطلوبة</li>
            <li>أضف توجيهات حول كيفية التعامل مع الاستفسارات المختلفة</li>
          </ul>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-12">
            <textarea class="form-control" id="systemInstructions" name="systemInstructions" rows="12"><%= aiSettings.systemInstructions %></textarea>
            <div class="token-counter">عدد الأحرف: <span id="charCount">0</span></div>
          </div>
        </div>
      </div>

      <!-- إعدادات الخيارات المتقدمة -->
      <div class="form-section">
        <h2 class="section-title"><i class="fas fa-sliders-h"></i> خيارات متقدمة</h2>
        <p class="text-muted">هذه الإعدادات تتحكم في سلوك محدد للنماذج وهي مفيدة للحالات المتخصصة.</p>
        
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="seed_advanced" class="form-label">قيمة البذرة (Seed)</label>
            <input type="number" class="form-control" id="seed_advanced" name="seed" value="<%= aiSettings.seed || '' %>">
            <div class="form-text">قيمة عشوائية لجعل ردود النموذج أكثر قابلية للتنبؤ. اتركها فارغة للحصول على ردود متنوعة.</div>
          </div>
          
          <div class="col-md-4">
            <label for="responseFormat_advanced" class="form-label">تنسيق الاستجابة</label>
            <select class="form-select" id="responseFormat_advanced" name="responseFormat">
              <option value="" <%= !aiSettings.responseFormat ? 'selected' : '' %>>افتراضي</option>
              <option value="text" <%= aiSettings.responseFormat === 'text' ? 'selected' : '' %>>نص عادي</option>
              <option value="json_object" <%= aiSettings.responseFormat === 'json_object' ? 'selected' : '' %>>كائن JSON</option>
            </select>
            <div class="form-text">تنسيق مخرجات النموذج (JSON للتطبيقات التي تتطلب بيانات منظمة).</div>
          </div>
          
          <div class="col-md-4">
            <label for="userIdentifier_advanced" class="form-label">معرّف المستخدم</label>
            <input type="text" class="form-control" id="userIdentifier_advanced" name="userIdentifier" value="<%= aiSettings.userIdentifier || '' %>">
            <div class="form-text">معرّف للمستخدم النهائي لتتبع استخدام API (اختياري).</div>
          </div>
        </div>
        
        <div class="row mb-3">
          <div class="col-md-4">
            <label for="stream_advanced" class="form-label">التدفق (Streaming)</label>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="stream_advanced" name="stream" <%= aiSettings.stream ? 'checked' : '' %>>
              <label class="form-check-label" for="stream_advanced">تفعيل التدفق</label>
            </div>
            <div class="form-text">بث ردود النماذج كلمة بكلمة بدلاً من انتظار الرد الكامل.</div>
          </div>
          
          <div class="col-md-4">
            <label for="truncation" class="form-label">تقنية التقصير</label>
            <select class="form-select" id="truncation" name="truncation">
              <option value="disabled" <%= aiSettings.truncation === 'disabled' ? 'selected' : '' %>>معطل</option>
              <option value="auto" <%= aiSettings.truncation === 'auto' ? 'selected' : '' %>>تلقائي</option>
            </select>
            <div class="form-text">كيفية تعامل النظام مع النصوص الطويلة.</div>
          </div>
          
          <div class="col-md-4">
            <label for="toolChoice" class="form-label">اختيار الأدوات</label>
            <select class="form-select" id="toolChoice" name="toolChoice">
              <option value="auto" <%= aiSettings.toolChoice === 'auto' ? 'selected' : '' %>>تلقائي</option>
              <option value="none" <%= aiSettings.toolChoice === 'none' ? 'selected' : '' %>>لا شيء</option>
              <option value="required" <%= aiSettings.toolChoice === 'required' ? 'selected' : '' %>>مطلوب</option>
            </select>
            <div class="form-text">كيفية استخدام النموذج للأدوات المتاحة (للنماذج التي تدعم استدعاء الوظائف).</div>
          </div>
        </div>
      </div>

      <div class="d-grid gap-2">
        <button type="submit" class="btn btn-ai btn-lg">
          <i class="fas fa-save"></i> حفظ إعدادات الذكاء الاصطناعي
        </button>
      </div>
    </form>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // تحديث قيم النطاقات عند التغيير
      const rangeInputs = document.querySelectorAll('input[type="range"]');
      rangeInputs.forEach(input => {
        const valueSpan = document.getElementById(`${input.id}Value`);
        input.addEventListener('input', function() {
          valueSpan.textContent = this.value;
        });
      });

      // عداد الأحرف لتعليمات النظام
      const systemInstructions = document.getElementById('systemInstructions');
      const charCount = document.getElementById('charCount');
      
      function updateCharCount() {
        charCount.textContent = systemInstructions.value.length;
      }
      
      systemInstructions.addEventListener('input', updateCharCount);
      updateCharCount(); // تحديث أولي
      
      // إظهار/إخفاء مفتاح API
      const toggleApiKey = document.getElementById('toggleApiKey');
      const apiKeyInput = document.getElementById('apiKey');
      
      toggleApiKey.addEventListener('click', function() {
        if (apiKeyInput.type === 'password') {
          apiKeyInput.type = 'text';
        } else {
          apiKeyInput.type = 'password';
        }
      });
      
      // استعادة الإعدادات الافتراضية
      document.getElementById('resetDefaults').addEventListener('click', function() {
        if (confirm('هل أنت متأكد من استعادة جميع الإعدادات إلى قيمها الافتراضية؟')) {
          window.location.href = '/settings/ai-settings-reset';
        }
      });

      // تحديث قيمة درجة حرارة الترحيب
      const greetingTempInput = document.getElementById('greetingTemperature');
      const greetingTempValueSpan = document.getElementById('greetingTemperatureValue');
      if (greetingTempInput && greetingTempValueSpan) {
        greetingTempInput.addEventListener('input', function() {
          greetingTempValueSpan.textContent = this.value;
        });
        // Ensure initial value is displayed correctly
        greetingTempValueSpan.textContent = greetingTempInput.value; 
      }
    });
  </script>
</body>
</html>