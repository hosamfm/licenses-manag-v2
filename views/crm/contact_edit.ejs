<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('../partials/_head') %>
  <title>تعديل جهة اتصال - إدارة العملاء</title>
  <!-- أنماط خاصة بصفحات CRM -->
  <style>
    .crm-container {
      display: flex;
      min-height: calc(100vh - 60px);
    }
    
    .crm-sidebar {
      width: 250px;
      background-color: #f8f9fa;
      border-left: 1px solid #dee2e6;
      padding: 20px 0;
    }
    
    .crm-content {
      flex: 1;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .crm-sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .crm-sidebar-nav li {
      margin-bottom: 5px;
    }
    
    .crm-sidebar-nav a {
      display: block;
      padding: 10px 20px;
      color: #6c757d;
      text-decoration: none;
      border-right: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .crm-sidebar-nav a:hover {
      background-color: #f0f0f0;
      color: #495057;
      border-right-color: #6c757d;
    }
    
    .crm-sidebar-nav a.active {
      background-color: #e9ecef;
      color: #212529;
      border-right-color: #0d6efd;
    }
    
    .crm-sidebar-nav i {
      width: 20px;
      text-align: center;
      margin-left: 8px;
    }
    
    .page-title {
      color: #495057;
      margin-bottom: 25px;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 15px;
    }
  </style>
</head>
<body>
  <%- include('../partials/_header') %>
  
  <div class="crm-container">
    <!-- القائمة الجانبية -->
    <div class="crm-sidebar">
      <ul class="crm-sidebar-nav">
        <li>
          <a href="/crm">
            <i class="fas fa-tachometer-alt"></i>
            <span>لوحة التحكم</span>
          </a>
        </li>
        <li>
          <a href="/crm/contacts" class="active">
            <i class="fas fa-address-book"></i>
            <span>جهات الاتصال</span>
          </a>
        </li>
        <li>
          <a href="/crm/conversations">
            <i class="fas fa-comments"></i>
            <span>المحادثات</span>
          </a>
        </li>
        <li>
          <a href="/crm/conversations/my">
            <i class="fas fa-user-circle"></i>
            <span>محادثاتي</span>
          </a>
        </li>
        <!-- يمكن إضافة روابط أخرى هنا في المستقبل -->
        <li class="mt-4">
          <a href="/" class="text-muted">
            <i class="fas fa-arrow-right"></i>
            <span>العودة للرئيسية</span>
          </a>
        </li>
      </ul>
    </div>
    
    <!-- المحتوى الرئيسي -->
    <div class="crm-content">
      <% if (flashMessages && flashMessages.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flashMessages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <% if (flashMessages && flashMessages.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flashMessages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      
      <!-- صفحة تعديل جهة اتصال -->
      <h1 class="page-title">
        <i class="fas fa-edit me-2"></i>
        تعديل جهة الاتصال: <%= contact.name %>
      </h1>

      <div class="card">
        <div class="card-body">
          <form action="/crm/contacts/<%= contact._id %>" method="POST">
            <!-- بيانات جهة الاتصال -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="name" class="form-label">الاسم <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name" value="<%= contact.name %>" required>
              </div>
              
              <div class="col-md-6">
                <label for="phoneNumber" class="form-label">رقم الهاتف <span class="text-danger">*</span></label>
                <div class="input-group">
                  <span class="input-group-text">+</span>
                  <input type="text" class="form-control" id="phoneNumber" name="phoneNumber" dir="ltr" 
                        value="<%= contact.phoneNumber && contact.phoneNumber.startsWith('+') ? contact.phoneNumber.substring(1) : contact.phoneNumber %>" required>
                </div>
                <small class="text-muted">أدخل الرقم بدون "+" (سيتم إضافته تلقائياً)</small>
              </div>
            </div>
            
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="email" class="form-label">البريد الإلكتروني</label>
                <input type="email" class="form-control" id="email" name="email" value="<%= contact.email || '' %>">
              </div>
              
              <div class="col-md-6">
                <label for="company" class="form-label">الشركة</label>
                <input type="text" class="form-control" id="company" name="company" value="<%= contact.company || '' %>">
              </div>
            </div>
            
            <div class="mb-3">
              <label for="notes" class="form-label">ملاحظات</label>
              <textarea class="form-control" id="notes" name="notes" rows="3"><%= contact.notes || '' %></textarea>
            </div>
            
            <!-- أزرار الإجراءات -->
            <div class="d-flex justify-content-between">
              <a href="/crm/contacts/<%= contact._id %>" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-1"></i>
                العودة للتفاصيل
              </a>
              
              <div>
                <button type="reset" class="btn btn-outline-secondary me-2">
                  <i class="fas fa-eraser me-1"></i>
                  إلغاء التعديلات
                </button>
                
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-save me-1"></i>
                  حفظ التعديلات
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <script>
        // التحقق من صحة رقم الهاتف قبل إرسال النموذج
        document.addEventListener('DOMContentLoaded', function() {
          const form = document.querySelector('form');
          const phoneInput = document.getElementById('phoneNumber');
          
          form.addEventListener('submit', function(e) {
            // إزالة أي مسافات أو حروف غير رقمية (باستثناء +)
            let phoneValue = phoneInput.value.trim();
            
            // إذا كان الرقم يبدأ بـ + نزيله لأن الواجهة تضيفه تلقائياً
            if (phoneValue.startsWith('+')) {
              phoneValue = phoneValue.substring(1);
            }
            
            // تنظيف الرقم من أي أحرف غير رقمية
            phoneValue = phoneValue.replace(/[^0-9]/g, '');
            
            // التأكد من أن الرقم يحتوي على أرقام فقط
            if (!/^\d+$/.test(phoneValue)) {
              alert('يرجى إدخال رقم هاتف صحيح');
              e.preventDefault();
              return false;
            }
            
            // تعيين قيمة الرقم بعد التنظيف
            phoneInput.value = phoneValue;
          });
        });
      </script>
    </div>
  </div>
  
  <%- include('../partials/_footer') %>
</body>
</html>
