<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('../partials/_head') %>
  <title>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</title>
  <!-- Ø±Ø¨Ø· Ù…Ù„Ù Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ù†Ø¸Ø§Ù… CRM -->
  <link rel="stylesheet" href="/css/crm.css">
  <link rel="stylesheet" href="/css/conversation.css">
  <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© Socket.IO - Ù…Ù‡Ù… Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  
  <!-- ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„Ø§Øª -->
  <script>
    // ØªØ¹Ø±ÙŠÙ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
    window.currentUserId = "<%= typeof user !== 'undefined' && user ? user._id : 'system' %>";
    window.currentUsername = "<%= typeof user !== 'undefined' && user ? user.username : 'Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù…' %>";
    
    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
    function sendReply(event) {
      if (event) event.preventDefault();
      
      const replyMessage = document.getElementById('replyMessage');
      const sendButton = document.getElementById('sendButton');
      const sendingIndicator = document.getElementById('sendingIndicator');
      const conversationId = document.getElementById('conversationId')?.value;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
      if (!replyMessage || !sendButton || !sendingIndicator || !conversationId) {
        console.error('Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©:', { 
          replyMessage: !!replyMessage, 
          sendButton: !!sendButton,
          sendingIndicator: !!sendingIndicator,
          conversationId: conversationId 
        });
        return;
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      if (!replyMessage.value.trim()) {
        alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        return;
      }
      
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
      sendButton.disabled = true;
      sendingIndicator.style.display = 'inline-block';
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
      fetch(`/crm/conversations/${conversationId}/reply`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          content: replyMessage.value.trim(),
          replyToMessageId: window.currentReplyToId || null
        })
      })
      .then(response => {
        if (!response.ok) throw new Error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
        return response.json();
      })
      .then(data => {
        console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­:', data);
        
        // Ù…Ø³Ø­ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        replyMessage.value = '';
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø±
        sendButton.disabled = false;
        sendingIndicator.style.display = 'none';
        
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯ Ø¥Ù† ÙˆØ¬Ø¯
        const replyIndicator = document.getElementById('replyIndicator');
        if (replyIndicator) replyIndicator.remove();
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ± Ø§Ù„Ø±Ø¯
        window.currentReplyToId = null;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        if (data.message) {
          window.addMessageToConversation(data.message);
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        refreshConversationsList();
      })
      .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø±
        sendButton.disabled = false;
        sendingIndicator.style.display = 'none';
        
        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
        window.showToast && window.showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'danger');
      });
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    window.showReactionPicker = function(messageId, externalId, buttonElement) {
      if (!messageId) return;
      
      console.log('ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø© showReactionPicker Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø±Ù:', messageId);
      
      // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ù‡Ø§
      const messageElem = buttonElement.closest('.message');
      if (!messageElem) {
        console.error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©!');
        return;
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
      let reactionPicker = document.getElementById('reactionPicker');
      
      if (!reactionPicker) {
        reactionPicker = document.createElement('div');
        reactionPicker.id = 'reactionPicker';
        reactionPicker.className = 'reaction-picker';
        
        const reactions = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ‘'];
        
        let buttonsHTML = '';
        reactions.forEach(emoji => {
          buttonsHTML += `<button class="reaction-emoji-btn" data-emoji="${emoji}">${emoji}</button>`;
        });
        
        reactionPicker.innerHTML = buttonsHTML;
        document.body.appendChild(reactionPicker);
        
        // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
        reactionPicker.querySelectorAll('.reaction-emoji-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const emoji = this.getAttribute('data-emoji');
            window.sendReaction(messageId, emoji, externalId);
            reactionPicker.remove();
          });
        });
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
        document.addEventListener('click', function closeReactionPicker(e) {
          if (!reactionPicker.contains(e.target) && 
              !e.target.classList.contains('reaction-btn') && 
              !e.target.closest('.reaction-btn')) {
            reactionPicker.remove();
            document.removeEventListener('click', closeReactionPicker);
          }
        });
      }
      
      // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø±Ø³Ø§Ù„Ø©
      const rect = buttonElement.getBoundingClientRect();
      const isRTL = document.dir === 'rtl';
      
      if (isRTL) {
        reactionPicker.style.right = `${rect.right}px`;
      } else {
        reactionPicker.style.left = `${rect.left}px`;
      }
      
      reactionPicker.style.top = `${rect.bottom + window.scrollY + 5}px`;
    };
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§Ø¹Ù„
    window.sendReaction = function(messageId, emoji, externalId) {
      if (!messageId || !emoji) return;
      
      console.log('Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§Ø¹Ù„:', messageId, emoji);
      
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
      const conversationId = document.getElementById('conversationId')?.value;
      if (!conversationId) {
        console.error('Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
        return;
      }
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
      fetch(`/crm/conversations/${conversationId}/reaction`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          messageId: messageId,
          externalMessageId: externalId,
          emoji: emoji,
          senderId: window.currentUserId,
          senderName: window.currentUsername
        })
      })
      .then(response => {
        if (!response.ok) throw new Error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„');
        return response.json();
      })
      .then(data => {
        console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ù†Ø¬Ø§Ø­:', data);
      })
      .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„:', error);
        window.showToast && window.showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'danger');
      });
    };
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ÙŠÙ†Ø©
    window.showReplyForm = function(messageId, externalId, messageElem) {
      if (!messageElem || !messageId) {
        console.error('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯:', { messageId, messageElem });
        return;
      }
      
      console.log('ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø© showReplyForm Ù…Ø¹ Ø§Ù„Ù…Ø¹Ø±Ù:', messageId);
      
      // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
      window.currentReplyToId = messageId;
      
      // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯
      let replyIndicator = document.getElementById('replyIndicator');
      
      if (!replyIndicator) {
        replyIndicator = document.createElement('div');
        replyIndicator.id = 'replyIndicator';
        replyIndicator.className = 'reply-indicator alert alert-info d-flex justify-content-between align-items-center py-2 mb-2';
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶
        const messageContent = messageElem.querySelector('.message-bubble').textContent.trim().substring(0, 50);
        
        replyIndicator.innerHTML = `
          <div>
            <i class="fas fa-reply me-1"></i>
            <small>Ø±Ø¯ Ø¹Ù„Ù‰: ${messageContent}${messageContent.length > 50 ? '...' : ''}</small>
          </div>
          <button type="button" class="btn btn-sm text-secondary cancel-reply-btn">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¤Ø´Ø± Ù‚Ø¨Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        const replyForm = document.getElementById('replyForm');
        if (replyForm) {
          replyForm.insertBefore(replyIndicator, replyForm.firstChild);
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯
        const cancelButton = replyIndicator.querySelector('.cancel-reply-btn');
        if (cancelButton) {
          cancelButton.addEventListener('click', function() {
            window.clearReplyIndicator();
          });
        }
      } else {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        const messageContent = messageElem.querySelector('.message-bubble').textContent.trim().substring(0, 50);
        replyIndicator.querySelector('small').innerHTML = `Ø±Ø¯ Ø¹Ù„Ù‰: ${messageContent}${messageContent.length > 50 ? '...' : ''}`;
      }
      
      // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
      const replyMessage = document.getElementById('replyMessage');
      if (replyMessage) {
        replyMessage.focus();
      }
    };
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯
    window.clearReplyIndicator = function() {
      const replyIndicator = document.getElementById('replyIndicator');
      if (replyIndicator) {
        replyIndicator.remove();
      }
      window.currentReplyToId = null;
    };
    
    // Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ø¯Ø¯Ø©
    window.currentReplyToId = null;
  </script>
</head>
<body>

  <%- include('../partials/_header') %>

  <div class="crm-container">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø§Ù„Ù…ÙˆØ­Ø¯ -->
    <%- include('../partials/_crm_sidebar') %>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="crm-content">

      <!-- Ø±Ø³Ø§Ø¦Ù„ ÙÙ„Ø§Ø´ Ø¥Ù† ÙˆØ¬Ø¯Øª -->
      <% if (flashMessages && flashMessages.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flashMessages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <% if (flashMessages && flashMessages.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flashMessages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <div class="row">

        <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠÙ…Ù†: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª -->
        <div class="col-lg-4">
          <h5 class="mb-3">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h5>
          <% if (conversations && conversations.length > 0) { %>
            <div class="list-group" id="conversationList">
              <% conversations.forEach(function(conv) { %>
                <button type="button"
                        class="list-group-item list-group-item-action conversation-item"
                        data-conversation-id="<%= conv._id %>">
                  <div class="d-flex justify-content-between">
                    <strong><%= conv.customerName || conv.phoneNumber %></strong>
                    <% if (conv.unreadCount > 0) { %>
                      <span class="badge bg-danger ms-2"><%= conv.unreadCount %></span>
                    <% } %>
                  </div>
                  <div class="mt-1">
                    <% if (conv.lastMessage) { %>
                      <small class="text-muted">
                        <%= conv.lastMessage.direction === 'incoming' ? 'Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©: ' : 'Ø±Ø³Ø§Ù„Ø© ØµØ§Ø¯Ø±Ø©: ' %>
                        <%= conv.lastMessage.content
                             ? conv.lastMessage.content.substring(0, 30)
                             : 'Ù…Ø­ØªÙˆÙ‰ ÙˆØ³Ø§Ø¦Ø·' %>...
                      </small>
                    <% } else { %>
                      <small class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</small>
                    <% } %>
                  </div>
                  <small class="text-muted d-block">
                    <%= new Date(conv.lastMessageAt || conv.updatedAt).toLocaleString('ar-LY') %>
                  </small>
                </button>
              <% }) %>
            </div>
          <% } else { %>
            <div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ù…ØªØ§Ø­Ø©.</div>
          <% } %>
        </div>

        <!-- Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø³ÙŠØªÙ… Ø­Ù‚Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙŠÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø© AJAX -->
        <div class="col-lg-8" id="conversationDetailsContainer">
          <div class="alert alert-secondary">
            Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„Ù‡Ø§...
          </div>
        </div>

      </div>
    </div>
  </div>

  <%- include('../partials/_footer') %>

  <!-- Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© -->
  <audio id="messageSound" src="/sounds/new-message.mp3" preload="auto"></audio>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ù„Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„Ù€ AJAX -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡Ø§)
      let currentConversationId = null;
      
      // ØªÙƒÙˆÙŠÙ† ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª
      const socket = io();
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø§ØªØµØ§Ù„
      socket.on('connect', function() {
        console.log('ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      });
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
      socket.on('disconnect', function() {
        console.log('Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…');
      });
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      socket.on('new-message', function(data) {
        console.log('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØµÙ„Øª:', data);
        
        // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
        if (data.direction === 'incoming') {
          playNotificationSound();
        }
        
        // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
        refreshConversationsList();
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ®Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø£Ø¶ÙÙ‡Ø§ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        if (data.conversationId === currentConversationId) {
          window.addMessageToConversation(data);
        }
      });
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      socket.on('message-status-update', function(data) {
        console.log('ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', data);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ†ØªÙ…ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (data.conversationId === currentConversationId) {
          updateMessageStatus(data.messageId, data.status);
        }
      });
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      socket.on('message_reply', function(data) {
        console.log('Ø±Ø¯ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©:', data);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ†ØªÙ…ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (data.conversationId === currentConversationId) {
          refreshConversationDetails();
        } else {
          // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª ÙÙ‚Ø·
          refreshConversationsList();
        }
      });
      
      // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      socket.on('message_reaction', function(data) {
        console.log('ØªÙØ§Ø¹Ù„ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©:', data);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªÙ†ØªÙ…ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        if (data.conversationId === currentConversationId) {
          refreshConversationDetails();
        }
      });
      
      // Ø¯Ø§Ù„Ø© Ù„ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
      function playNotificationSound() {
        try {
          const sound = document.getElementById('messageSound');
          if (sound) {
            sound.currentTime = 0;
            sound.play().catch(err => console.error('Ø®Ø·Ø£ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', err));
          }
        } catch (error) {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:', error);
        }
      }
      
      // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      function updateMessageStatus(messageId, newStatus) {
        if (!messageId || !newStatus) return;
        
        // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const messageElem = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (!messageElem) return;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù…Ø©
        messageElem.setAttribute('data-status', newStatus);
        
        // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø©
        const statusIcon = messageElem.querySelector('.message-status i');
        if (statusIcon) {
          // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
          statusIcon.className = '';
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          if (newStatus === 'sending') {
            statusIcon.className = 'fas fa-clock text-secondary';
            statusIcon.title = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
          } else if (newStatus === 'sent') {
            statusIcon.className = 'fas fa-check text-silver';
            statusIcon.title = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
          } else if (newStatus === 'delivered') {
            statusIcon.className = 'fas fa-check-double text-silver';
            statusIcon.title = 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…';
          } else if (newStatus === 'read') {
            statusIcon.className = 'fas fa-check-double text-primary';
            statusIcon.title = 'ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©';
          } else if (newStatus === 'failed') {
            statusIcon.className = 'fas fa-exclamation-triangle text-danger';
            statusIcon.title = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
          }
        }
      }
      
      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      function refreshConversationsList() {
        fetch('/crm/conversations/ajax/list', {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('HTTP error ' + response.status);
          return response.json();
        })
        .then(data => {
          if (data.success && data.conversations && data.conversations.length > 0) {
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
            const conversationList = document.getElementById('conversationList');
            if (conversationList) {
              // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
              const activeConversation = conversationList.querySelector('.active');
              const activeId = activeConversation ? activeConversation.getAttribute('data-conversation-id') : null;
              
              // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
              let html = '';
              data.conversations.forEach(conv => {
                const isActive = (conv._id === activeId) ? 'active' : '';
                const hasBadge = (conv.unreadCount > 0) ? `<span class="badge bg-danger ms-2">${conv.unreadCount}</span>` : '';
                
                html += `
                  <button type="button"
                          class="list-group-item list-group-item-action conversation-item ${isActive}"
                          data-conversation-id="${conv._id}">
                    <div class="d-flex justify-content-between">
                      <strong>${conv.customerName || conv.phoneNumber}</strong>
                      ${hasBadge}
                    </div>
                    <div class="mt-1">
                      ${conv.lastMessage ? 
                        `<small class="text-muted">
                          ${conv.lastMessage.direction === 'incoming' ? 'Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©: ' : 'Ø±Ø³Ø§Ù„Ø© ØµØ§Ø¯Ø±Ø©: '}
                          ${conv.lastMessage.content.substring(0, 30)}${conv.lastMessage.content.length > 30 ? '...' : ''}
                        </small>` : 
                        '<small class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</small>'
                      }
                    </div>
                  </button>
                `;
              });
              
              // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
              conversationList.innerHTML = html;
              
              // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
              attachConversationItemsEvents();
            }
          }
        })
        .catch(error => {
          console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª:', error);
          // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ 404ØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© - Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
          if (error.message.includes('404')) {
            window.location.href = '/crm/conversations/ajax';
          }
        });
      }
      
      // Ø¯Ø§Ù„Ø© Ù„ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
      function attachConversationItemsEvents() {
        const conversationList = document.getElementById('conversationList');
        if (!conversationList) return;
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ ÙƒÙ„ Ù…Ø­Ø§Ø¯Ø«Ø©
        const items = conversationList.querySelectorAll('.conversation-item');
        items.forEach(item => {
          item.addEventListener('click', function() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            items.forEach(i => i.classList.remove('active'));
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…Ø­Ø¯Ø¯
            this.classList.add('active');
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
            const convId = this.getAttribute('data-conversation-id');
            if (!convId) return;
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            currentConversationId = convId;
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±Ù Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØµÙØ­
            if (history.pushState) {
              const url = `/crm/conversations/${convId}`;
              history.pushState({ conversationId: convId }, '', url);
            }
            
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ AJAX Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„
            loadConversationDetails(convId);
          });
        });
      }
      
      // ØªØ­Ù…ÙŠÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
      function loadConversationDetails(conversationId) {
        if (!conversationId) return;
        
        const detailsContainer = document.getElementById('conversationDetailsContainer');
        if (!detailsContainer) return;
        
        // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
        detailsContainer.innerHTML = `
          <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
            </div>
            <p class="mt-2">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©...</p>
          </div>
        `;
        
        // Ø·Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
        fetch(`/crm/conversations/ajax/details/${conversationId}`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('HTTP error ' + response.status);
          return response.text();
        })
        .then(html => {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰
          detailsContainer.innerHTML = html;
          
          // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
          currentConversationId = conversationId;
          
          // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª
          socket.emit('join-conversation', conversationId);
          console.log('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', conversationId);
          
          // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ø£Ø³ÙÙ„ Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
          setTimeout(() => {
            const msgContainer = document.getElementById('messageContainer');
            if (msgContainer) {
              msgContainer.scrollTop = msgContainer.scrollHeight;
            }
          }, 100);

          // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
          window.attachConversationEventListeners && window.attachConversationEventListeners();
        })
        .catch(err => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©:', err);
          detailsContainer.innerHTML = `
            <div class="alert alert-danger">
              Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©: ${err.message}
            </div>
          `;
        });
      }

      // ØªØ­Ø¯ÙŠØ« ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„)
      window.refreshConversationDetails = function() {
        if (currentConversationId) {
          loadConversationDetails(currentConversationId);
        }
      };
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      window.addMessageToConversation = function(messageData) {
        if (!messageData || !currentConversationId) return;
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ®Øµ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        if (messageData.conversationId !== currentConversationId) return;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        const messageContainer = document.getElementById('messageContainer');
        if (!messageContainer) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ù„Ù…Ù†Ø¹ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø±ØªÙŠÙ†)
        const messageExists = document.querySelector(`.message[data-message-id="${messageData._id}"]`);
        if (messageExists) {
          console.log('Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ØŒ ØªØ®Ø·ÙŠ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰:', messageData._id);
          return;
        }
        
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
        const messageDate = new Date(messageData.timestamp || messageData.createdAt || Date.now());
        const formattedDate = messageDate.toLocaleString('ar-LY');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        const messageElem = document.createElement('div');
        messageElem.className = `message ${messageData.direction}`;
        messageElem.setAttribute('data-message-id', messageData._id);
        messageElem.setAttribute('data-status', messageData.status || 'sent');
        
        if (messageData.externalId) {
          messageElem.setAttribute('data-external-id', messageData.externalId);
        }
        
        // ØªØ­Ø¯ÙŠØ¯ HTML Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        let messageHTML = '';
        const isMedia = messageData.mediaType && messageData.mediaType !== 'text';
        
        if (isMedia) {
          // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù†ÙˆØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
          messageHTML = `
            <div class="message-bubble media-message">
              <div class="media-content">
                <i class="fas fa-paperclip me-1"></i>
                Ù…Ø­ØªÙˆÙ‰ ÙˆØ³Ø§Ø¦Ø· (${messageData.mediaType})
              </div>
            </div>
          `;
        } else {
          // Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¹Ø§Ø¯ÙŠØ©
          messageHTML = `
            <div class="message-bubble">
              ${messageData.content || ''}
            </div>
          `;
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±
        messageHTML += `
          <div class="message-info">
            <small class="message-time">${formattedDate}</small>
            ${messageData.direction === 'outgoing' ? 
              `<span class="message-status">
                <i class="${messageData.status === 'sent' ? 'fas fa-check' : 
                          messageData.status === 'delivered' ? 'fas fa-check-double text-silver' : 
                          messageData.status === 'read' ? 'fas fa-check-double text-primary' : 
                          'fas fa-clock'}" title="${messageData.status || 'Ù…Ø±Ø³Ù„Ø©'}"></i>
              </span>` : ''}
          </div>
          <div class="message-actions">
            <button type="button" class="btn btn-sm reply-btn" 
                    data-message-id="${messageData._id}" 
                    ${messageData.externalId ? `data-external-id="${messageData.externalId}"` : ''}>
              <i class="fas fa-reply"></i>
            </button>
            <!-- ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§ Ù…Ø«Ù„ Ø²Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¥Ù„Ø® -->
          </div>
        `;
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        messageElem.innerHTML = messageHTML;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        messageContainer.appendChild(messageElem);
        
        // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù„Ø£Ø³ÙÙ„
        messageContainer.scrollTop = messageContainer.scrollHeight;
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        setupMessageActions(messageElem);
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
      function setupMessageActions(messageElem) {
        if (!messageElem) return;
        
        // Ø²Ø± Ø§Ù„Ø±Ø¯
        const replyButton = messageElem.querySelector('.reply-btn');
        if (replyButton) {
          replyButton.addEventListener('click', function() {
            const messageId = this.getAttribute('data-message-id');
            const externalId = this.getAttribute('data-external-id');
            showReplyForm(messageId, externalId, messageElem);
          });
        }
        
        // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰ Ù…Ø«Ù„ Ø²Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ØŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ Ø¥Ù„Ø®
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
      window.showToast = function(message, type = 'info') {
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        let toastContainer = document.getElementById('toast-container');
        if (!toastContainer) {
          toastContainer = document.createElement('div');
          toastContainer.id = 'toast-container';
          toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
          document.body.appendChild(toastContainer);
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ ID ÙØ±ÙŠØ¯ Ù„Ù„Ø¥Ø´Ø¹Ø§Ø±
        const toastId = 'toast-' + Date.now();
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const toastHTML = `
          <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
              <span class="bg-${type} toast-icon me-2"></span>
              <strong class="me-auto">${type === 'info' ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª' : type === 'success' ? 'Ù†Ø¬Ø§Ø­' : 'ØªÙ†Ø¨ÙŠÙ‡'}</strong>
              <small>${new Date().toLocaleTimeString('ar-LY')}</small>
              <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
            </div>
            <div class="toast-body">
              ${message}
            </div>
          </div>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø­Ø§ÙˆÙŠØ©
        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Bootstrap
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
          animation: true,
          autohide: true,
          delay: 5000
        });
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        toast.show();
      };
      
      // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
      function initializePage() {
        const conversationList = document.getElementById('conversationList');
        if (!conversationList) return;
        
        // ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        attachConversationItemsEvents();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø¹Ù†ÙˆØ§Ù† URL Ø§Ù„Ø­Ø§Ù„ÙŠ
        const urlParts = window.location.pathname.split('/');
        const convIdIndex = urlParts.indexOf('conversations') + 1;
        
        if (convIdIndex > 0 && urlParts.length > convIdIndex && urlParts[convIdIndex] !== 'ajax') {
          const convId = urlParts[convIdIndex];
          
          // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù†Ø´Ø·Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          const item = conversationList.querySelector(`[data-conversation-id="${convId}"]`);
          if (item) {
            item.classList.add('active');
            currentConversationId = convId;
            loadConversationDetails(convId);
          }
        } else {
          // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø­Ø§Ø¯Ø«Ø©ØŒ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£ÙˆÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          const firstConv = conversationList.querySelector('.conversation-item');
          if (firstConv) {
            firstConv.click();
          }
        }
      }
      
      // ØªÙ†ÙÙŠØ° Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      initializePage();
      
      // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙ†Ù‚Ù„ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ (Ø§Ù„Ø±Ø¬ÙˆØ¹/Ø§Ù„ØªÙ‚Ø¯Ù…)
      window.addEventListener('popstate', function(event) {
        if (event.state && event.state.conversationId) {
          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          currentConversationId = event.state.conversationId;
          loadConversationDetails(currentConversationId);
          
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          const conversationList = document.getElementById('conversationList');
          if (conversationList) {
            const items = conversationList.querySelectorAll('.conversation-item');
            items.forEach(item => {
              item.classList.remove('active');
              if (item.getAttribute('data-conversation-id') === currentConversationId) {
                item.classList.add('active');
              }
            });
          }
        }
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
      setInterval(refreshConversationsList, 60000);
    });
  </script>
</body>
</html>
