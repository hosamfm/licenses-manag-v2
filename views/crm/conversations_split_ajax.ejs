<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('../partials/_head') %>
  <title>المحادثات</title>
  <!-- ربط ملف التنسيقات الخاص بنظام CRM -->
  <link rel="stylesheet" href="/css/crm.css">
  <link rel="stylesheet" href="/css/conversation.css">
  <!-- إضافة مكتبة Socket.IO - مهم لوظائف المحادثات الفورية -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  
  <!-- تعريف معلومات المستخدم كمتغيرات عامة -->
  <script>
    window.currentUserId = "<%= typeof user !== 'undefined' && user ? user._id : 'system' %>";
    window.currentUsername = "<%= typeof user !== 'undefined' && user ? user.username : 'مستخدم النظام' %>";
  </script>
  
  <!-- استدعاء ملف المساعدة للمحادثات -->
  <script src="/js/conversation-utils.js"></script>
</head>
<body>

  <%- include('../partials/_header') %>

  <div class="crm-container">
    <!-- الشريط الجانبي الموحد -->
    <%- include('../partials/_crm_sidebar') %>

    <!-- المحتوى الرئيسي -->
    <div class="crm-content">

      <!-- رسائل فلاش إن وجدت -->
      <% if (flashMessages && flashMessages.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flashMessages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <% if (flashMessages && flashMessages.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flashMessages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <div class="row">

        <!-- العمود الأيمن: قائمة المحادثات -->
        <div class="col-lg-4">
          <h5 class="mb-3">قائمة المحادثات</h5>
          <% if (conversations && conversations.length > 0) { %>
            <div class="list-group" id="conversationList">
              <% conversations.forEach(function(conv) { %>
                <button type="button"
                        class="list-group-item list-group-item-action conversation-item"
                        data-conversation-id="<%= conv._id %>">
                  <div class="d-flex justify-content-between">
                    <strong><%= conv.customerName || conv.phoneNumber %></strong>
                    <% if (conv.unreadCount > 0) { %>
                      <span class="badge bg-danger ms-2"><%= conv.unreadCount %></span>
                    <% } %>
                  </div>
                  <div class="mt-1">
                    <% if (conv.lastMessage) { %>
                      <small class="text-muted">
                        <%= conv.lastMessage.direction === 'incoming' ? 'رسالة واردة: ' : 'رسالة صادرة: ' %>
                        <%= conv.lastMessage.content
                             ? conv.lastMessage.content.substring(0, 30)
                             : 'محتوى وسائط' %>...
                      </small>
                    <% } else { %>
                      <small class="text-muted">لا توجد رسائل</small>
                    <% } %>
                  </div>
                  <small class="text-muted d-block">
                    <%= new Date(conv.lastMessageAt || conv.updatedAt).toLocaleString('ar-LY') %>
                  </small>
                </button>
              <% }) %>
            </div>
          <% } else { %>
            <div class="alert alert-info">لا توجد محادثات متاحة.</div>
          <% } %>
        </div>

        <!-- العمود الأيسر: سيتم حقن تفاصيل المحادثة فيه بواسطة AJAX -->
        <div class="col-lg-8" id="conversationDetailsContainer">
          <div class="alert alert-secondary">
            اختر محادثة من القائمة لعرض تفاصيلها...
          </div>
        </div>

      </div>
    </div>
  </div>

  <%- include('../partials/_footer') %>

  <!-- عنصر الصوت للتنبيه عند وصول رسالة جديدة -->
  <audio id="messageSound" src="/sounds/new-message.mp3" preload="auto"></audio>

  <!-- سكربت جافاسكربت لجلب التفاصيل بالـ AJAX -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // معرف المحادثة الحالية (إذا تم تحديدها)
      let currentConversationId = null;
      
      // تكوين وتهيئة الويب سوكت
      const socket = io();
      
      // الاستماع لأحداث الاتصال
      socket.on('connect', function() {
        // تم الاتصال بالخادم
      });
      
      // الاستماع لأحداث قطع الاتصال
      socket.on('disconnect', function() {
        // انقطع الاتصال بالخادم
      });
      
      // الاستماع لأحداث الرسائل الجديدة
      socket.on('new-message', function(data) {
        // تشغيل صوت الإشعار للرسائل الواردة
        if (data.direction === 'incoming') {
          window.playNotificationSound();
        }
        
        // تحديث قائمة المحادثات
        refreshConversationsList();
        
        // إذا كانت الرسالة تخص المحادثة المفتوحة حالياً، أضفها للمحادثة
        if (data.conversationId === currentConversationId) {
          window.addMessageToConversation(data);
        }
      });
      
      // الاستماع لأحداث تحديث حالة الرسائل
      socket.on('message-status-update', function(data) {
        // تحقق من وجود معرف المحادثة والتأكد من أنه يطابق المحادثة الحالية
        if (!data.conversationId || data.conversationId !== currentConversationId) {
          return;
        }
        
        // استخدم المعرف الخارجي لتحديث حالة الرسالة
        if (data.externalId) {
          window.updateMessageStatus(data.externalId, data.status);
        } else if (data.messageId) {
          // دعم للإصدارات القديمة التي قد ترسل messageId بدلاً من externalId
          window.updateMessageStatus(data.messageId, data.status);
        }
      });
      
      // الاستماع لأحداث الردود الجديدة
      socket.on('message-reply', function(data) {
        // التحقق من وجود البيانات المطلوبة
        if (!data || !data.message) {
          return;
        }
        
        // إذا وُجدت بيانات الرسالة والرد، استخدم دالة إضافة الرسالة مباشرةً
        if (data.message && data.replyToId) {
          // إضافة معرف المحادثة للرسالة إذا لم يكن موجودًا
          if (!data.message.conversationId) {
            data.message.conversationId = currentConversationId;
          }
          
          // ضمان وجود replyToMessageId في الرسالة
          if (!data.message.replyToMessageId) {
            data.message.replyToMessageId = data.replyToId;
          }
          
          // إضافة الرسالة للواجهة إذا كانت المحادثة الحالية
          if (data.message.conversationId === currentConversationId) {
            window.addMessageToConversation(data.message);
          } else {
            // تحديث قائمة المحادثات فقط إذا كانت محادثة أخرى
            refreshConversationsList();
          }
        } else {
          // السلوك القديم - إعادة تحميل المحادثة بالكامل كإجراء احتياطي
          if (data.conversationId === currentConversationId) {
            refreshConversationDetails();
          } else {
            refreshConversationsList();
          }
        }
      });
      
      // الاستماع لأحداث التفاعلات الجديدة
      socket.on('message-reaction', function(data) {
        // التحقق من أن البيانات تخص المحادثة الحالية
        if (!data.conversationId || data.conversationId !== currentConversationId) {
          return;
        }
        
        // استخدام الدالة الجديدة لتحديث التفاعل مباشرة بدلاً من إعادة تحميل المحادثة بالكامل
        window.updateMessageReaction(data.externalId, data.reaction);
      });
      
      // الاستماع لأحداث تحديث المعرف الخارجي للرسالة
      socket.on('message-external-id-update', function(data) {
        // التحقق من أن البيانات تخص المحادثة الحالية
        if (!data.conversationId || data.conversationId !== currentConversationId) {
          return;
        }
        
        // البحث عن عنصر الرسالة حسب المعرف الداخلي
        const messageElem = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        
        if (!messageElem) {
          return;
        }
        
        // إضافة المعرف الخارجي للرسالة
        messageElem.setAttribute('data-external-id', data.externalId);
      });
      
      // تحديث قائمة المحادثات بدون إعادة تحميل الصفحة
      function refreshConversationsList() {
        fetch('/crm/conversations/ajax/list', {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('HTTP error ' + response.status);
          return response.json();
        })
        .then(data => {
          if (data.success && data.conversations && data.conversations.length > 0) {
            // إعادة بناء قائمة المحادثات
            const conversationList = document.getElementById('conversationList');
            if (conversationList) {
              // حفظ معرف المحادثة النشطة حالياً (إن وجدت)
              const activeConversation = conversationList.querySelector('.active');
              const activeId = activeConversation ? activeConversation.getAttribute('data-conversation-id') : null;
              
              // إعادة بناء القائمة
              let html = '';
              data.conversations.forEach(conv => {
                const isActive = (conv._id === activeId) ? 'active' : '';
                const hasBadge = (conv.unreadCount > 0) ? `<span class="badge bg-danger ms-2">${conv.unreadCount}</span>` : '';
                
                html += `
                  <button type="button"
                          class="list-group-item list-group-item-action conversation-item ${isActive}"
                          data-conversation-id="${conv._id}">
                    <div class="d-flex justify-content-between">
                      <strong>${conv.customerName || conv.phoneNumber}</strong>
                      ${hasBadge}
                    </div>
                    <div class="mt-1">
                      ${conv.lastMessage ? 
                        `<small class="text-muted">
                          ${conv.lastMessage.direction === 'incoming' ? 'رسالة واردة: ' : 'رسالة صادرة: '}
                          ${conv.lastMessage.content.substring(0, 30)}${conv.lastMessage.content.length > 30 ? '...' : ''}
                        </small>` : 
                        '<small class="text-muted">لا توجد رسائل</small>'
                      }
                    </div>
                  </button>
                `;
              });
              
              // تحديث المحتوى
              conversationList.innerHTML = html;
              
              // إعادة تعيين مستمعات الأحداث
              attachConversationItemsEvents();
            }
          }
        })
        .catch(error => {
          console.error('خطأ في تحديث قائمة المحادثات:', error);
          // في حالة الخطأ 404، قد يكون المستخدم في الواجهة القديمة - نقوم بإعادة التوجيه إلى الواجهة الجديدة
          if (error.message.includes('404')) {
            window.location.href = '/crm/conversations/ajax';
          }
        });
      }
      
      // دالة لتعيين مستمعات أحداث لعناصر قائمة المحادثات
      function attachConversationItemsEvents() {
        const conversationList = document.getElementById('conversationList');
        if (!conversationList) return;
        
        // إضافة مستمع الأحداث للنقر على كل محادثة
        const items = conversationList.querySelectorAll('.conversation-item');
        items.forEach(item => {
          item.addEventListener('click', function() {
            // إزالة الفئة النشطة من جميع العناصر
            items.forEach(i => i.classList.remove('active'));
            
            // إضافة الفئة النشطة للعنصر المحدد
            this.classList.add('active');
            
            // الحصول على معرف المحادثة
            const convId = this.getAttribute('data-conversation-id');
            if (!convId) return;
            
            // تحديث معرف المحادثة الحالية
            currentConversationId = convId;
            
            // إضافة المعرف إلى تاريخ المتصفح
            if (history.pushState) {
              const url = `/crm/conversations/${convId}`;
              history.pushState({ conversationId: convId }, '', url);
            }
            
            // استدعاء AJAX لتحميل التفاصيل
            loadConversationDetails(convId);
          });
        });
      }
      
      // تحميل تفاصيل المحادثة
      function loadConversationDetails(conversationId) {
        if (!conversationId) return;
        
        const detailsContainer = document.getElementById('conversationDetailsContainer');
        if (!detailsContainer) return;
        
        // عرض مؤشر التحميل
        detailsContainer.innerHTML = `
          <div class="text-center p-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <p class="mt-2">جاري تحميل المحادثة...</p>
          </div>
        `;
        
        // طلب التفاصيل من الخادم
        fetch(`/crm/conversations/ajax/details/${conversationId}`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => {
          if (!response.ok) throw new Error('HTTP error ' + response.status);
          return response.text();
        })
        .then(html => {
          // تحديث المحتوى
          detailsContainer.innerHTML = html;
          
          // تحديث معرف المحادثة الحالية
          currentConversationId = conversationId;
          
          // الانضمام إلى غرفة المحادثة عبر الويب سوكت
          socket.emit('join-conversation', conversationId);
          
          // التمرير لأسفل آخر الرسائل
          setTimeout(() => {
            const msgContainer = document.getElementById('messageContainer');
            if (msgContainer) {
              msgContainer.scrollTop = msgContainer.scrollHeight;
            }
          }, 100);

          // تعيين المستمعين للتفاعلات مع الرسائل بعد تحميل المحادثة
          window.attachConversationEventListeners && window.attachConversationEventListeners();
        })
        .catch(err => {
          console.error('خطأ في جلب تفاصيل المحادثة:', err);
          detailsContainer.innerHTML = `
            <div class="alert alert-danger">
              حدث خطأ أثناء جلب تفاصيل المحادثة: ${err.message}
            </div>
          `;
        });
      }

      // تحديث تفاصيل المحادثة (إعادة تحميل)
      window.refreshConversationDetails = function() {
        if (currentConversationId) {
          loadConversationDetails(currentConversationId);
        }
      };
      
      // دالة لإضافة رسالة جديدة للمحادثة الحالية
      window.addMessageToConversation = function(messageData) {
        if (!messageData || !currentConversationId) return;
        
        // التأكد من أن الرسالة تخص المحادثة الحالية
        if (messageData.conversationId !== currentConversationId) return;
        
        // إضافة الرسالة لواجهة المستخدم
        const messageContainer = document.getElementById('messageContainer');
        if (!messageContainer) return;
        
        // تحضير HTML الرسالة
        let messageHTML = `
          <div class="message ${messageData.direction}"
                data-message-id="${messageData._id}"
                data-status="${messageData.status}"
                ${messageData.externalMessageId ? `data-external-id="${messageData.externalMessageId}"` : ''}>
        `;
        
        // إضافة محتوى الاقتباس إذا كان موجودًا
        if (messageData.replyToMessageId) {
          // البحث عن الرسالة المقتبسة في الواجهة
          const repliedMsgElem = document.querySelector(`.message[data-message-id="${messageData.replyToMessageId}"], .message[data-external-id="${messageData.replyToMessageId}"]`);
          
          messageHTML += `<div class="replied-message">`;
          
          if (repliedMsgElem) {
            // الحصول على محتوى الرسالة المقتبسة
            const repliedContent = repliedMsgElem.querySelector('.message-bubble').innerText || '';
            const displayContent = repliedContent.length > 50 ? repliedContent.substring(0, 50) + '...' : repliedContent;
            
            messageHTML += `
              <div class="replied-content">
                <i class="fas fa-reply"></i>
                <span>${displayContent}</span>
              </div>
            `;
          } else {
            messageHTML += `
              <div class="replied-content text-muted">
                <i class="fas fa-reply"></i>
                <span>رد على رسالة غير موجودة</span>
                <small class="text-muted d-block">(المعرف: ${messageData.replyToMessageId.substring(0, 10)}...)</small>
              </div>
            `;
          }
          
          messageHTML += `</div>`;
        }
        
        // إضافة محتوى الرسالة
        messageHTML += `<div class="message-bubble ${messageData.direction === 'incoming' ? 'incoming-bubble' : 'outgoing-bubble'}">`;
        
        // معالجة المحتوى بناءً على نوع الرسالة (نص أو وسائط)
        if (messageData.mediaType) {
          // استخدام الدالة الجديدة لإنشاء محتوى الوسائط
          messageHTML += window.createMediaMessageContent(messageData);
        } else {
          // رسالة نصية عادية
          messageHTML += messageData.content;
        }
        
        // إضافة وقت الإرسال وحالة الرسالة
        messageHTML += `
          <div class="message-time">
            ${new Date(messageData.timestamp).toLocaleString('ar-LY')}
            
            ${messageData.direction === 'outgoing' ? `
              <span class="message-status">
                ${messageData.status === 'sending' ? `<i class="fas fa-clock text-secondary" title="جاري الإرسال..."></i>` : ''}
                ${messageData.status === 'sent' ? `<i class="fas fa-check text-silver" title="تم الإرسال"></i>` : ''}
                ${messageData.status === 'delivered' ? `<i class="fas fa-check-double text-silver" title="تم التسليم"></i>` : ''}
                ${messageData.status === 'read' ? `<i class="fas fa-check-double text-primary" title="تم القراءة"></i>` : ''}
                ${messageData.status === 'failed' ? `<i class="fas fa-exclamation-triangle text-danger" title="فشل الإرسال"></i>` : ''}
              </span>
            ` : ''}
          </div>
        `;
        
        // إغلاق حاوية محتوى الرسالة
        messageHTML += `</div>`;
        
        // إضافة التفاعلات إذا كانت موجودة
        if (messageData.reactions && messageData.reactions.length > 0) {
          messageHTML += `<div class="message-reactions">`;
          
          messageData.reactions.forEach(function(reaction) {
            messageHTML += `
              <span class="reaction-emoji" title="تفاعل من ${reaction.sender}">
                ${reaction.emoji}
              </span>
            `;
          });
          
          messageHTML += `</div>`;
        }
        
        // إضافة أزرار التفاعل
        messageHTML += `
          <div class="message-actions">
            <button type="button" class="btn btn-sm text-muted message-action-btn reaction-btn" 
                    title="تفاعل" onclick="window.showReactionPicker('${messageData._id}', '${messageData.externalMessageId || ''}', this)">
              <i class="far fa-smile"></i>
            </button>
            <button type="button" class="btn btn-sm text-muted message-action-btn reply-btn" 
                    data-message-id="${messageData._id}" 
                    data-external-id="${messageData.externalMessageId || ''}" 
                    title="رد" onclick="window.showReplyForm('${messageData._id}', '${messageData.externalMessageId || ''}', this.closest('.message'))">
              <i class="fas fa-reply"></i>
            </button>
          </div>
        `;
        
        // إغلاق عنصر الرسالة
        messageHTML += `</div><div class="clear-both"></div>`;
        
        // إضافة الرسالة لحاوية الرسائل
        messageContainer.insertAdjacentHTML('beforeend', messageHTML);
        
        // تمرير المحادثة للأسفل
        messageContainer.scrollTop = messageContainer.scrollHeight;
        
        // تشغيل صوت الإشعار للرسائل الواردة
        if (messageData.direction === 'incoming') {
          window.playNotificationSound();
        }
        
        // تفعيل عناصر الصوت بعد إضافتها
        window.setupAudioPlayers();
      }
      
      // تهيئة الصفحة عند التحميل
      function initializePage() {
        const conversationList = document.getElementById('conversationList');
        if (!conversationList) return;
        
        // تعيين مستمعات الأحداث للقائمة
        attachConversationItemsEvents();
        
        // محاولة استخراج معرف المحادثة من عنوان URL الحالي
        const urlParts = window.location.pathname.split('/');
        const convIdIndex = urlParts.indexOf('conversations') + 1;
        
        if (convIdIndex > 0 && urlParts.length > convIdIndex && urlParts[convIdIndex] !== 'ajax') {
          const convId = urlParts[convIdIndex];
          
          // تحديد المحادثة نشطة في القائمة
          const item = conversationList.querySelector(`[data-conversation-id="${convId}"]`);
          if (item) {
            item.classList.add('active');
            currentConversationId = convId;
            loadConversationDetails(convId);
          }
        } else {
          // إذا لم يتم تحديد محادثة، يمكن تحديد الأول في القائمة
          const firstConv = conversationList.querySelector('.conversation-item');
          if (firstConv) {
            firstConv.click();
          }
        }
      }
      
      // تنفيذ عند تحميل الصفحة
      initializePage();
      
      // معالجة أحداث التنقل في المتصفح (الرجوع/التقدم)
      window.addEventListener('popstate', function(event) {
        if (event.state && event.state.conversationId) {
          // تحميل المحادثة المحددة
          currentConversationId = event.state.conversationId;
          loadConversationDetails(currentConversationId);
          
          // تحديث القائمة
          const conversationList = document.getElementById('conversationList');
          if (conversationList) {
            const items = conversationList.querySelectorAll('.conversation-item');
            items.forEach(item => {
              item.classList.remove('active');
              if (item.getAttribute('data-conversation-id') === currentConversationId) {
                item.classList.add('active');
              }
            });
          }
        }
      });
      
      // تحديث القائمة كل دقيقة للتأكد من الحصول على أحدث المحادثات
      setInterval(refreshConversationsList, 60000);
    });
  </script>
  
  <!-- استدعاء الوظائف عند تحميل المحادثة -->
  <script>
    $(document).ready(function() {
      // تحديث روابط جميع الوسائط عند تحميل المحادثة
      refreshAllMediaUrls();
      
      // إعادة تحديث روابط الوسائط كل 8 ساعات للملفات المعروضة
      setInterval(refreshAllMediaUrls, 8 * 60 * 60 * 1000);
    });
  </script>
</body>
</html>
