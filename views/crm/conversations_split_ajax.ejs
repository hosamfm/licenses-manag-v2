<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('../partials/_head') %>
  <title>المحادثات</title>
  <!-- إضافة SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  
  <!-- ربط ملف التنسيقات الخاص بنظام CRM -->
  <link rel="stylesheet" href="/css/crm.css">
  <link rel="stylesheet" href="/css/conversation-new.css">
  
  <!-- إضافة مكتبة Tribute.js لدعم المنشن في التعليقات -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>
  
  <!-- إضافة ملف معالجة Socket.IO - مهم لوظائف المحادثات الفورية -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  
  <!-- استدعاء ملفات المساعدة -->
  <%- include('./partials/_head_chat_modules') %>
  <script src="/js/contact-helper.js"></script>
  <script src="/js/notifications.js"></script>
  <script src="/js/socket-utils.js"></script>
  <script src="/js/conversations-page.js"></script>
  
  <!-- تعريف معلومات المستخدم كمتغيرات عامة -->
  <script>
    // تعريف المتغيرات العامة بشكل صحيح
    window.currentUserId = '<%= typeof user !== "undefined" && user && user._id ? user._id : "system" %>';
    window.currentUsername = '<%= typeof user !== "undefined" && user && user.username ? user.username : "مستخدم النظام" %>';
    
    // تهيئة كائن الفلاتر الافتراضية
    window.currentFilters = {
      status: 'open',     // افتراضي: المحادثات المفتوحة
      assignment: 'all',  // افتراضي: كل المحادثات
      searchTerm: ''
    };

    // متغير لتتبع معرف المحادثة المفتوحة حاليًا
    window.currentConversationId = null;

    // كائن اتصال Socket.io العام
    window.socketConnection = null;
    window.socketConnected = false;

    // مستمع لتهيئة الاتصال بعد تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      window.socketConnection = io();

      window.socketConnection.on('connect', function() {
        window.socketConnected = true;
        console.log('تم الاتصال بالسوكت بنجاح (conversations_split_ajax)');
      });

      window.socketConnection.on('disconnect', function() {
        window.socketConnected = false;
        console.log('تم قطع الاتصال بالسوكت (conversations_split_ajax)');
      });

      // إعداد مستمعات الإشعارات العامة
      if (typeof window.setupNotificationListeners === 'function') {
         window.setupNotificationListeners(window.socketConnection);
      }
    });
  </script>
</head>
<!-- إضافة فئة page-fills-height للتحكم في الهامش السفلي -->
<body class="page-fills-height">
  <%- include('../partials/_header') %>

  <div class="crm-container">
    <!-- الشريط الجانبي الموحد -->
    <%- include('../partials/_crm_sidebar') %>

    <!-- المحتوى الرئيسي -->
    <div class="crm-content">
      <!-- رسائل فلاش إن وجدت -->
      <% if (flashMessages && flashMessages.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flashMessages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <% if (flashMessages && flashMessages.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flashMessages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <div class="row conversations-view-container">
        <!-- العمود الأيمن: قائمة المحادثات -->
        <div class="col-lg-4 conversations-list-column mobile-hidden">
          <div class="conversations-sidebar h-100">
            <div class="conversations-header">
              <h5><i class="fas fa-comments me-2 text-primary"></i> المحادثات</h5>
            </div>
            
            <!-- منطقة الفلاتر والبحث -->
            <div class="conversation-filters-search">
              <div class="input-group search-container">
                <span class="input-group-text">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="conversationSearchInput" class="form-control" placeholder="بحث...">
              </div>
              <div class="conversation-filters">
                <div class="filter-status">
                  <select class="form-select form-select-sm" id="filterStatus">
                    <option value="open" selected>المفتوحة</option>
                    <option value="closed">المغلقة</option>
                  </select>
                </div>
                <div class="filter-assignment">
                  <select class="form-select form-select-sm" id="filterAssignment">
                    <option value="all" selected>الكل</option>
                    <option value="mine">محادثاتي</option>
                    <option value="unassigned">غير مسندة</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- حاوية قائمة المحادثات -->
            <div class="conversations-list" id="conversationList">
              <!-- عرض مؤشر تحميل أولي -->
              <div id="conversationListLoader" class="conversation-list-loader">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="loading-text">جاري تحميل المحادثات...</p>
              </div>
              
              <!-- رسالة عدم وجود محادثات -->
              <div id="noConversationsMessage" class="no-conversations-message d-none">
                 <i class="fas fa-info-circle"></i> لا توجد محادثات تطابق الفلتر الحالي.
              </div>
            </div>
          </div>
        </div>

        <!-- العمود الأيسر: تفاصيل المحادثة -->
        <div class="col-lg-8 conversation-details-column">
          <!-- إضافة زر تبديل قائمة المحادثات هنا، مرئي فقط على الجوال -->
          <button class="btn btn-sm btn-outline-secondary d-lg-none conversation-list-toggler" type="button" id="conversationListToggler" aria-label="Toggle Conversation List">
            <i class="fas fa-list"></i> عرض المحادثات
          </button>
          <div class="conversation-details-container" id="conversationDetailsContainer">
            <div class="conversation-welcome">
              <i class="fas fa-comments welcome-icon"></i>
              <h4>حدد محادثة</h4>
              <p>اختر محادثة من القائمة على اليمين لعرضها.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/_footer') %>

  <!-- عنصر الصوت للتنبيه عند وصول رسالة جديدة -->
  <audio id="messageSound" src="/sounds/new-message.mp3" preload="auto"></audio>
</body>
</html>
