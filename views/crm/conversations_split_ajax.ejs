<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('../partials/_head') %>
  <title>المحادثات</title>
  <!-- إضافة SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  
  <!-- ربط ملف التنسيقات الخاص بنظام CRM -->
  <link rel="stylesheet" href="/css/crm.css">
  <link rel="stylesheet" href="/css/conversation-new.css">
  
  <!-- إضافة مكتبة Tribute.js لدعم المنشن في التعليقات -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>
  
  <!-- إضافة ملف معالجة Socket.IO - مهم لوظائف المحادثات الفورية -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  
  <!-- استدعاء ملفات المساعدة -->
  <%- include('./partials/_head_chat_modules') %>
  <script src="/js/conversation-utils.js"></script>
  <script src="/js/notifications.js"></script>
  <script src="/js/socket-utils.js"></script>
  <script src="/js/conversations-page.js"></script> <!-- تم إزالة defer لضمان تحميل وتنفيذ الملف فورًا -->
  
  <!-- تعريف معلومات المستخدم كمتغيرات عامة -->
  <script>
    
    // تعريف المتغيرات العامة بشكل صحيح
    window.currentUserId = '<%= typeof user !== "undefined" && user && user._id ? user._id : "system" %>';
    window.currentUsername = '<%= typeof user !== "undefined" && user && user.username ? user.username : "مستخدم النظام" %>';
    
    // تهيئة كائن الفلاتر الافتراضية
    window.currentFilters = {
      status: 'open',     // افتراضي: المحادثات المفتوحة
      assignment: 'all', // افتراضي: كل المحادثات
      searchTerm: ''
    };

    // متغير لتتبع معرف المحادثة المفتوحة حاليًا
    window.currentConversationId = null;

    // كائن اتصال Socket.io العام
    window.socketConnection = null;
    window.socketConnected = false;

    // مستمع لتهيئة الاتصال بعد تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      window.socketConnection = io();

      window.socketConnection.on('connect', function() {
        window.socketConnected = true;
        console.log('تم الاتصال بالسوكت بنجاح (conversations_split_ajax)');
        // يمكن تنفيذ عمليات أولية هنا إذا لزم الأمر
      });

      window.socketConnection.on('disconnect', function() {
        window.socketConnected = false;
        console.log('تم قطع الاتصال بالسوكت (conversations_split_ajax)');
      });

      // أي تهيئة أخرى لـ Socket.IO لا تتعلق مباشرة بالقائمة أو التفاصيل يمكن أن تبقى هنا
       // إعداد مستمعات الإشعارات العامة
      if (typeof window.setupNotificationListeners === 'function') {
         window.setupNotificationListeners(window.socketConnection);
      }
    });
    
  </script>
</head>
<body>

  <%- include('../partials/_header') %>

  <div class="crm-container">
    <!-- الشريط الجانبي الموحد -->
    <%- include('../partials/_crm_sidebar') %>

    <!-- المحتوى الرئيسي -->
    <div class="crm-content">

      <!-- رسائل فلاش إن وجدت -->
      <% if (flashMessages && flashMessages.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flashMessages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <% if (flashMessages && flashMessages.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flashMessages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <div class="row">

        <!-- العمود الأيمن: قائمة المحادثات -->
        <div class="col-lg-4">
          <div class="conversations-sidebar border-end h-100">
            <div class="conversations-header p-3 border-bottom">
              <h5 class="mb-0"><i class="fas fa-comments me-2 text-primary"></i> المحادثات</h5>
            </div>
            
            <!-- منطقة الفلاتر الجديدة والبحث -->
            <div class="conversation-filters-search p-3 border-bottom">
              <div class="input-group mb-3">
                <span class="input-group-text bg-light border-end-0">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="conversationSearchInput" class="form-control border-start-0" placeholder="بحث...">
              </div>
              <div class="d-flex gap-2">
                <div class="flex-grow-1">
                  <label for="filterStatus" class="form-label visually-hidden">الحالة</label>
                  <select class="form-select form-select-sm" id="filterStatus">
                    <option value="open" selected>المفتوحة</option>
                    <option value="closed">المغلقة</option>
                  </select>
                </div>
                <div class="flex-grow-1">
                  <label for="filterAssignment" class="form-label visually-hidden">التعيين</label>
                  <select class="form-select form-select-sm" id="filterAssignment">
                    <option value="all" selected>الكل</option>
                    <option value="mine">محادثاتي</option>
                    <option value="unassigned">غير مسندة</option> <!-- إضافة خيار غير مسندة -->
                  </select>
                </div>
              </div>
            </div>
            
            <!-- حاوية قائمة المحادثات (سيتم ملؤها بواسطة JavaScript) -->
            <div class="list-group conversations-list list-group-flush overflow-auto" id="conversationList" style="height: calc(100vh - 250px);"> <!-- تعديل الارتفاع ليناسب التخطيط -->
              <!-- عرض مؤشر تحميل أولي -->
              <div id="conversationListLoader" class="text-center p-5">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                <p class="mt-2 small text-muted">جاري تحميل المحادثات...</p>
              </div>
              <!-- سيتم حقن عناصر المحادثات هنا -->
              <div id="noConversationsMessage" class="alert alert-light text-center m-3 d-none">
                 <i class="fas fa-info-circle me-1"></i> لا توجد محادثات تطابق الفلتر الحالي.
              </div>
            </div>

            <!-- إزالة حلقة العرض الأصلية والجافاسكريبت المضمن لإدارة القائمة -->

          </div>
        </div>

        <!-- العمود الأيسر: سيتم حقن تفاصيل المحادثة فيه بواسطة AJAX -->
        <div class="col-lg-8" id="conversationDetailsContainer">
          <div class="conversation-welcome d-flex justify-content-center align-items-center h-100">
            <div class="text-center p-5 text-muted">
              <i class="fas fa-comments display-4 mb-4"></i>
              <h4 class="mb-3">حدد محادثة</h4>
              <p>اختر محادثة من القائمة على اليمين لعرضها.</p>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <%- include('../partials/_footer') %>

  <!-- عنصر الصوت للتنبيه عند وصول رسالة جديدة -->
  <audio id="messageSound" src="/sounds/new-message.mp3" preload="auto"></audio>

  <!-- إزالة السكربت المضمن الذي كان يدير القائمة والفلترة والتفاصيل -->
  <!-- سيتم التعامل مع كل هذا في conversations-page.js -->

</body>
</html>
