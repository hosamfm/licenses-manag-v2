<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <%- include('../partials/_head') %>
  <title>المحادثات</title>
  <!-- إضافة SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  
  <!-- ربط ملف التنسيقات الخاص بنظام CRM -->
  <link rel="stylesheet" href="/css/crm.css">
  <link rel="stylesheet" href="/css/conversation-new.css">
  
  <!-- إضافة مكتبة Tribute.js لدعم المنشن في التعليقات -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.css">
  <script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>
  
  <!-- إضافة ملف معالجة Socket.IO - مهم لوظائف المحادثات الفورية -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
  
  <!-- استدعاء ملفات المساعدة -->
  <%- include('./partials/_head_chat_modules') %>
  <script src="/js/contact-helper.js"></script>
  <script src="/js/notifications.js"></script>
  <script src="/js/socket-utils.js"></script>
  <script src="/js/conversations-page.js"></script>
  
  <!-- تعريف معلومات المستخدم كمتغيرات عامة -->
  <script>
    // تعريف المتغيرات العامة بشكل صحيح
    window.currentUserId = '<%= typeof user !== "undefined" && user && user._id ? user._id : "system" %>';
    window.currentUsername = '<%= typeof user !== "undefined" && user && user.username ? user.username : "مستخدم النظام" %>';
    
    // تهيئة كائن الفلاتر الافتراضية
    window.currentFilters = {
      status: 'open',     // افتراضي: المحادثات المفتوحة
      assignment: 'all',  // افتراضي: كل المحادثات
      searchTerm: ''
    };

    // متغير لتتبع معرف المحادثة المفتوحة حاليًا
    window.currentConversationId = null;

    // كائن اتصال Socket.io العام
    window.socketConnection = null;
    window.socketConnected = false;

    // مستمع لتهيئة الاتصال بعد تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      window.socketConnection = io();

      window.socketConnection.on('connect', function() {
        window.socketConnected = true;
        console.log('تم الاتصال بالسوكت بنجاح (conversations_split_ajax)');
      });

      window.socketConnection.on('disconnect', function() {
        window.socketConnected = false;
        console.log('تم قطع الاتصال بالسوكت (conversations_split_ajax)');
      });

      // إعداد مستمعات الإشعارات العامة
      if (typeof window.setupNotificationListeners === 'function') {
         window.setupNotificationListeners(window.socketConnection);
      }
    });
  </script>
</head>
<!-- إضافة فئة page-fills-height للتحكم في الهامش السفلي -->
<body class="page-fills-height">
  <%- include('../partials/_header') %>

  <div class="crm-container">
    <!-- الشريط الجانبي الموحد -->
    <%- include('../partials/_crm_sidebar') %>

    <!-- المحتوى الرئيسي -->
    <div class="crm-content">
      <!-- رسائل فلاش إن وجدت -->
      <% if (flashMessages && flashMessages.error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flashMessages.error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>
      <% if (flashMessages && flashMessages.success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flashMessages.success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      <% } %>

      <div class="row conversations-view-container">
        <!-- العمود الأيمن: قائمة المحادثات -->
        <div class="col-lg-4 conversations-list-column mobile-hidden">
          <div class="conversations-sidebar h-100">
            <div class="conversations-header">
              <h5><i class="fas fa-comments me-2 text-primary"></i> المحادثات</h5>
            </div>
            
            <!-- منطقة الفلاتر والبحث -->
            <div class="conversation-filters-search">
              <div class="input-group search-container">
                <span class="input-group-text">
                  <i class="fas fa-search text-muted"></i>
                </span>
                <input type="text" id="conversationSearchInput" class="form-control" placeholder="بحث...">
              </div>
              <div class="conversation-filters">
                <div class="filter-status">
                  <select class="form-select form-select-sm" id="filterStatus">
                    <option value="open" selected>المفتوحة</option>
                    <option value="closed">المغلقة</option>
                  </select>
                </div>
                <div class="filter-assignment">
                  <select class="form-select form-select-sm" id="filterAssignment">
                    <option value="all" selected>الكل</option>
                    <option value="mine">محادثاتي</option>
                    <option value="unassigned">غير مسندة</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- حاوية قائمة المحادثات -->
            <div class="conversations-list" id="conversationList">
              <!-- عرض مؤشر تحميل أولي -->
              <div id="conversationListLoader" class="conversation-list-loader">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <p class="loading-text">جاري تحميل المحادثات...</p>
              </div>
              
              <!-- رسالة عدم وجود محادثات -->
              <div id="noConversationsMessage" class="no-conversations-message d-none">
                 <i class="fas fa-info-circle"></i> لا توجد محادثات تطابق الفلتر الحالي.
              </div>
            </div>
          </div>
        </div>

        <!-- العمود الأيسر: تفاصيل المحادثة -->
        <div class="col-lg-8 conversation-details-column">
          <!-- إضافة زر تبديل قائمة المحادثات هنا، مرئي فقط على الجوال -->
          <button class="btn btn-sm btn-outline-secondary d-lg-none conversation-list-toggler" type="button" id="conversationListToggler" aria-label="Toggle Conversation List">
            <i class="fas fa-list"></i> عرض المحادثات
          </button>
          <div class="conversation-details-container" id="conversationDetailsContainer">
            <div class="conversation-welcome">
              <i class="fas fa-comments welcome-icon"></i>
              <h4>حدد محادثة</h4>
              <p>اختر محادثة من القائمة على اليمين لعرضها.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/_footer') %>

  <!-- عنصر الصوت للتنبيه عند وصول رسالة جديدة -->
  <audio id="messageSound" src="/sounds/new-message.mp3" preload="auto"></audio>
  
  <!-- نافذة منبثقة لعرض معلومات جهة الاتصال -->
  <div class="modal fade" id="contactInfoModal" tabindex="-1" aria-labelledby="contactInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="contactInfoModalLabel">معلومات جهة الاتصال</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body" id="contactInfoContent">
          <!-- سيتم ملء هذا المحتوى بواسطة الجافاسكريبت -->
        </div>
        <div class="modal-footer">
          <a href="#" class="btn btn-primary" id="viewContactDetailsBtn" style="display: none;">
            <i class="fas fa-external-link-alt me-1"></i>
            عرض تفاصيل الملف الكامل
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // دالة عامة لفتح نافذة معلومات جهة الاتصال
    // تخزين مؤقت لبيانات جهات الاتصال التي تم جلبها سابقًا
    window.contactsCache = {};
    
    window.openContactInfoModal = function(contactId) {
      if (!contactId) return;
      
      // عرض النافذة المنبثقة فورًا
      $('#contactInfoModal').modal('show');
      
      // محاولة استرداد أي بيانات متوفرة عن العميل من صفحة المحادثة الحالية
      let initialName = '';
      let initialPhone = '';
      
      // البحث عن العنصر الذي تم النقر عليه للحصول على أي معلومات أولية
      const nameElement = document.querySelector('.customer-name a[data-contact-id="'+contactId+'"]');
      if (nameElement) {
        initialName = nameElement.textContent.trim().replace(/\s*ⓘ\s*$/, '');
      }
      
      // البحث عن رقم الهاتف في المحادثة إن وجد
      const phoneElement = document.querySelector('.phoneNumber[data-contact-id="'+contactId+'"]');
      if (phoneElement) {
        initialPhone = phoneElement.textContent.trim();
      }
      
      // عرض البيانات المتوفرة مبدئيًا
      if (initialName) {
        $('#contactInfoContent').html(`
          <div class="text-center mb-3">
            <div class="avatar-lg mx-auto">
              <i class="fas fa-user-circle fa-4x text-primary"></i>
            </div>
            <h4 class="mt-2">${initialName}</h4>
          </div>
          <div class="contact-info-details">
            ${initialPhone ? `
            <div class="mb-2 row">
              <div class="col-sm-4 text-muted">رقم الهاتف:</div>
              <div class="col-sm-8 fw-bold" dir="ltr">${initialPhone}</div>
            </div>` : ''}
            <div class="text-center">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">جاري تحميل التفاصيل...</span>
              </div>
              <small class="text-muted ms-2">جاري تحميل المعلومات الإضافية...</small>
            </div>
          </div>
        `);
      } else {
        // إذا لم تتوفر بيانات أولية، عرض مؤشر التحميل
        $('#contactInfoContent').html(`
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">جاري التحميل...</span>
            </div>
            <p class="mt-2">جاري تحميل معلومات جهة الاتصال...</p>
          </div>
        `);
      }
      
      // تحديث زر عرض التفاصيل على الفور
      $('#viewContactDetailsBtn').attr('href', `/crm/contacts/${contactId}`).show();
      
      // التحقق من وجود البيانات في التخزين المؤقت
      if (window.contactsCache[contactId]) {
        // استخدام البيانات المخزنة مؤقتًا
        updateContactModalContent(window.contactsCache[contactId]);
        return;
      }
      
      // جلب معلومات جهة الاتصال من الخادم
      fetch(`/api/contacts/${contactId}`)
        .then(response => response.ok ? response.json() : Promise.reject('فشل جلب بيانات جهة الاتصال'))
        .then(data => {
          if (data.success && data.contact) {
            // تخزين البيانات في الذاكرة المؤقتة
            window.contactsCache[contactId] = data.contact;
            // تحديث محتوى النافذة
            updateContactModalContent(data.contact);
          } else {
            handleContactFetchError('تعذر تحميل معلومات جهة الاتصال. يرجى المحاولة مرة أخرى.');
          }
        })
        .catch(error => {
          console.error('خطأ في جلب معلومات جهة الاتصال:', error);
          handleContactFetchError('حدث خطأ أثناء جلب معلومات جهة الاتصال. يرجى المحاولة مرة أخرى.');
        });
    };
    
    // دالة لتحديث محتوى النافذة المنبثقة
    function updateContactModalContent(contact) {
      $('#contactInfoContent').html(`
        <div class="text-center mb-3">
          <div class="avatar-lg mx-auto">
            <i class="fas fa-user-circle fa-4x text-primary"></i>
          </div>
          <h4 class="mt-2">${contact.name}</h4>
        </div>
        
        <div class="contact-info-details">
          <div class="mb-2 row">
            <div class="col-sm-4 text-muted">رقم الهاتف:</div>
            <div class="col-sm-8 fw-bold" dir="ltr">${contact.phoneNumber}</div>
          </div>
          
          <div class="mb-2 row">
            <div class="col-sm-4 text-muted">البريد الإلكتروني:</div>
            <div class="col-sm-8">${contact.email || 'غير محدد'}</div>
          </div>
          
          <div class="mb-2 row">
            <div class="col-sm-4 text-muted">الشركة:</div>
            <div class="col-sm-8">${contact.company || 'غير محدد'}</div>
          </div>
        </div>
      `);
    }
    
    // دالة لمعالجة أخطاء جلب البيانات
    function handleContactFetchError(errorMessage) {
      // إضافة رسالة خطأ مع الاحتفاظ بأي معلومات أولية معروضة
      const currentContent = $('#contactInfoContent').html();
      if (currentContent.includes('spinner-border')) {
        $('#contactInfoContent').html(`
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            ${errorMessage}
          </div>
        `);
      } else {
        // إذا كانت هناك بيانات معروضة بالفعل، إضافة رسالة خطأ في الأسفل
        $('#contactInfoContent').append(`
          <div class="alert alert-warning mt-3">
            <i class="fas fa-exclamation-circle me-2"></i>
            <small>${errorMessage}</small>
          </div>
        `);
      }
    }
    
    // إضافة مستمع الحدث للنقر على رابط معلومات جهة الاتصال
    $(document).on('click', '.contact-info-link', function(e) {
      e.preventDefault();
      const contactId = $(this).data('contact-id');
      window.openContactInfoModal(contactId);
    });
  </script>
</body>
</html>
