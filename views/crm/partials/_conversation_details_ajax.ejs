<!-- Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø²Ø¦ÙŠ (Partial) ÙŠØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-comments me-1"></i>
        Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ <%= conversation.customerName || conversation.phoneNumber %>
      </h5>
      <span class="badge bg-primary"><%= messages.length %> Ø±Ø³Ø§Ù„Ø©</span>
    </div>
    <div class="card-body p-0" id="messageContainer" style="max-height: 500px; overflow-y: auto;">
      <% if (messages && messages.length) { %>
        <% messages.forEach((msg, index) => { %>
          <div class="message <%= msg.direction %>"
               data-message-id="<%= msg._id %>"
               data-status="<%= msg.status %>"
               <% if (msg.externalMessageId) { %> data-external-id="<%= msg.externalMessageId %>" <% } %>>
            
            <% if (msg.replyToMessageId) { %>
              <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚ØªØ¨Ø³Ø© ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø±Ø¯ -->
              <div class="replied-message">
                <% const repliedMsg = messages.find(m => m.externalMessageId === msg.replyToMessageId); %>
                <% if (repliedMsg) { %>
                  <div class="replied-content">
                    <i class="fas fa-reply"></i>
                    <span><%= repliedMsg.content.length > 50 ? repliedMsg.content.substring(0, 50) + '...' : repliedMsg.content %></span>
                  </div>
                <% } else { %>
                  <div class="replied-content text-muted">
                    <i class="fas fa-reply"></i>
                    <span>Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</span>
                  </div>
                <% } %>
              </div>
            <% } %>
            
            <div class="message-bubble <%= msg.direction === 'incoming' ? 'incoming-bubble' : 'outgoing-bubble' %>">
              <%= msg.content %>
              <div class="message-time">
                <%= new Date(msg.timestamp).toLocaleString('ar-LY') %>
                
                <% if (msg.direction === 'outgoing') { %>
                  <span class="message-status">
                    <% if (msg.status === 'sending') { %>
                      <i class="fas fa-clock text-secondary" title="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."></i>
                    <% } else if (msg.status === 'sent') { %>
                      <i class="fas fa-check text-silver" title="ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>
                    <% } else if (msg.status === 'delivered') { %>
                      <i class="fas fa-check-double text-silver" title="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"></i>
                    <% } else if (msg.status === 'read') { %>
                      <i class="fas fa-check-double text-primary" title="ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"></i>
                    <% } else if (msg.status === 'failed') { %>
                      <i class="fas fa-exclamation-triangle text-danger" title="ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>
                    <% } %>
                  </span>
                <% } %>
              </div>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
            <% if (msg.reactions && msg.reactions.length > 0) { %>
              <div class="message-reactions">
                <% msg.reactions.forEach(function(reaction) { %>
                  <span class="reaction-emoji" title="ØªÙØ§Ø¹Ù„ Ù…Ù† <%= reaction.sender %>">
                    <%= reaction.emoji %>
                  </span>
                <% }); %>
              </div>
            <% } %>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
            <div class="message-actions">
              <button class="btn btn-sm text-muted message-action-btn reaction-btn" title="ØªÙØ§Ø¹Ù„">
                <i class="far fa-smile"></i>
              </button>
              <button class="btn btn-sm text-muted message-action-btn reply-btn" 
                      data-message-id="<%= msg._id %>" 
                      data-external-id="<%= msg.externalMessageId %>" 
                      title="Ø±Ø¯">
                <i class="fas fa-reply"></i>
              </button>
            </div>
          </div>
          <div class="clear-both"></div>
          
          <% if (index < messages.length - 1 && 
                  new Date(messages[index+1].timestamp) - new Date(msg.timestamp) > 3600000) { %>
            <div class="message-internal-note text-muted my-2" style="font-size: 0.85rem;">
              <i class="fas fa-clock me-1"></i>
              Ù…Ø±Øª <%= Math.round((new Date(messages[index+1].timestamp) - new Date(msg.timestamp)) / 3600000) %> Ø³Ø§Ø¹Ø©
            </div>
          <% } %>
        <% }) %>
      <% } else { %>
        <div class="text-center text-muted py-3">
          <i class="fas fa-comment-dots mb-3" style="font-size: 3rem; opacity: 0.2;"></i>
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.</p>
        </div>
      <% } %>
    </div>
  </div>
  
  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØºÙŠØ± Ù…ØºÙ„Ù‚Ø©) -->
  <% if (conversation.status !== 'closed') { %>
    <form id="replyForm" action="/crm/conversations/<%= conversation._id %>/reply" method="POST" class="mt-3">
      <div class="mb-3">
        <label for="replyMessage" class="form-label">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</label>
        <textarea class="form-control" id="replyMessage" name="content"
                  rows="3" required placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„)"></textarea>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <span class="sending-indicator" id="sendingIndicator" style="display: none;">
          <i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...
        </span>
        <button type="reset" class="btn btn-outline-secondary">Ù…Ø³Ø­</button>
        <button type="submit" class="btn btn-primary" id="sendButton">
          <i class="fas fa-paper-plane me-1"></i> Ø¥Ø±Ø³Ø§Ù„
        </button>
      </div>
    </form>
  <% } else { %>
    <div class="alert alert-secondary mt-3">
      <i class="fas fa-lock me-1"></i>
      Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ØºÙ„Ù‚Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø¯.
    </div>
  <% } %>

<!-- ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© CSS Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„Ù…Ù„ÙÙŠÙ† conversations_split_ajax.ejs Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<style>
  .message {
    position: relative;
    margin-bottom: 15px;
    clear: both;
    max-width: 75%;
  }
  
  .message.incoming {
    float: left;
  }
  
  .message.outgoing {
    float: right;
  }
  
  .message-bubble {
    padding: 8px 12px;
    border-radius: 15px;
    position: relative;
    word-wrap: break-word;
  }
  
  .incoming-bubble {
    background-color: #e9ecef;
    border-bottom-left-radius: 5px;
  }
  
  .outgoing-bubble {
    background-color: #d4edda;
    border-bottom-right-radius: 5px;
  }
  
  .message-time {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 3px;
    text-align: right;
  }
  
  .message-actions {
    position: absolute;
    right: 5px;
    bottom: -20px;
    opacity: 0;
    transition: opacity 0.2s;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    padding: 0 5px;
    display: flex;
  }
  
  .message.incoming .message-actions {
    left: 5px;
    right: auto;
  }
  
  .message:hover .message-actions {
    opacity: 1;
  }
  
  .message-action-btn {
    padding: 0.1rem 0.3rem;
  }
  
  .replied-message {
    margin-bottom: 5px;
    padding: 5px;
    background-color: rgba(0,0,0,0.03);
    border-radius: 10px;
    font-size: 0.85rem;
  }
  
  .clear-both {
    clear: both;
  }
  
  .message-reactions {
    position: absolute;
    bottom: -15px;
    right: 10px;
    background: white;
    padding: 2px 5px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .message.incoming .message-reactions {
    left: 10px;
    right: auto;
  }
  
  .message-internal-note {
    text-align: center;
    padding: 5px;
    border-radius: 15px;
    clear: both;
  }
  
  .sending-indicator {
    color: #6c757d;
    display: none;
  }
  
  .sending-indicator i {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<!-- Ø¥Ø¶Ø§ÙØ© JavaScript Ù„ØªÙ…ÙƒÙŠÙ† ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± DOM
    const replyForm = document.getElementById('replyForm');
    const replyMessage = document.getElementById('replyMessage');
    const sendButton = document.getElementById('sendButton');
    const sendingIndicator = document.getElementById('sendingIndicator');
    const messageContainer = document.getElementById('messageContainer');
    
    // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    let currentReplyToId = null;
    let currentReplyToExternalId = null;
    let replyIndicator = null;
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯
    if (replyForm) {
      replyForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ø±Ø¯
        if (!replyMessage.value.trim()) {
          return;
        }
        
        // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        sendButton.disabled = true;
        sendingIndicator.style.display = 'inline-block';
        
        // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† FormData
        const formData = new FormData(replyForm);
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…ÙØ±ÙØ¯ Ø¹Ù„ÙŠÙ‡Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ù‹Ø§
        if (currentReplyToExternalId) {
          formData.append('replyToMessageId', currentReplyToExternalId);
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… fetch API
        fetch(replyForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          sendButton.disabled = false;
          sendingIndicator.style.display = 'none';
          
          if (data.success) {
            // Ù…Ø³Ø­ Ù…Ø­ØªÙˆÙ‰ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø¯ ÙˆØ¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯
            replyMessage.value = '';
            resetReplyState();
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙŠÙ…ÙƒÙ† Ø¥Ù…Ø§ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            // Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ø¯Ø§Ù„Ø© refreshConversation() ÙŠØªÙ… ØªØ¹Ø±ÙŠÙÙ‡Ø§ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ù…
            if (typeof refreshConversationDetails === 'function') {
              refreshConversationDetails();
            }
          } else {
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
            alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯.');
          }
        })
        .catch(error => {
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          sendButton.disabled = false;
          sendingIndicator.style.display = 'none';
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        });
      });
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø­Ø¯Ø« Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„
    messageContainer.addEventListener('click', function(e) {
      // Ø²Ø± Ø§Ù„Ø±Ø¯
      if (e.target.closest('.reply-btn')) {
        const replyBtn = e.target.closest('.reply-btn');
        const messageId = replyBtn.getAttribute('data-message-id');
        const externalId = replyBtn.getAttribute('data-external-id');
        const messageElem = replyBtn.closest('.message');
        showReplyForm(messageId, externalId, messageElem);
      }
      
      // Ø²Ø± Ø§Ù„ØªÙØ§Ø¹Ù„
      if (e.target.closest('.reaction-btn')) {
        const reactionBtn = e.target.closest('.reaction-btn');
        const messageElem = reactionBtn.closest('.message');
        const messageId = messageElem.getAttribute('data-message-id');
        const externalId = messageElem.getAttribute('data-external-id');
        showReactionPicker(messageId, externalId);
      }
    });
    
    // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    messageContainer.scrollTop = messageContainer.scrollHeight;
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯ Ù…Ø¹ Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
    function showReplyForm(messageId, externalId, messageElem) {
      if (!messageElem || !messageId) return;
      
      // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
      currentReplyToId = messageId;
      currentReplyToExternalId = externalId;
      
      // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù…Ø¤Ø´Ø± Ø±Ø¯ Ø³Ø§Ø¨Ù‚
      if (replyIndicator) {
        replyIndicator.remove();
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯
      replyIndicator = document.createElement('div');
      replyIndicator.className = 'reply-indicator alert alert-info alert-dismissible fade show';
      
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      const msgContent = messageElem.querySelector('.message-bubble').textContent.trim();
      const truncatedContent = msgContent.length > 50 ? msgContent.substring(0, 50) + '...' : msgContent;
      
      replyIndicator.innerHTML = `
        <strong>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰:</strong> ${truncatedContent}
        <button type="button" class="btn-close" onclick="resetReplyState()"></button>
      `;
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯ Ù‚Ø¨Ù„ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯
      if (replyForm) {
        replyForm.insertAdjacentElement('beforebegin', replyIndicator);
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø±Ø¯
        replyMessage.focus();
      }
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯
    window.resetReplyState = function() {
      currentReplyToId = null;
      currentReplyToExternalId = null;
      
      if (replyIndicator) {
        replyIndicator.remove();
        replyIndicator = null;
      }
    };
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
    function showReactionPicker(messageId, externalId) {
      if (!messageId) return;
      
      // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ù‡Ø§
      const messageElem = document.querySelector(`.message[data-message-id="${messageId}"]`);
      
      if (!messageElem) return;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù†ØªÙ‚ÙŠ ØªÙØ§Ø¹Ù„Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„
      const existingPicker = document.querySelector('.reaction-picker');
      if (existingPicker) {
        existingPicker.remove();
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
      const reactionPicker = document.createElement('div');
      reactionPicker.className = 'reaction-picker';
      reactionPicker.innerHTML = `
        <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
        <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘</button>
        <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸</button>
        <button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚</button>
        <button class="emoji-btn" data-emoji="ğŸ˜®">ğŸ˜®</button>
        <button class="emoji-btn" data-emoji="ğŸ˜¢">ğŸ˜¢</button>
      `;
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· CSS Ø§Ù„Ù…Ø¶Ù…Ù†Ø©
      reactionPicker.style.cssText = `
        position: absolute;
        background: white;
        border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        padding: 5px 10px;
        z-index: 1000;
        display: flex;
      `;
      
      // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
      if (messageElem.classList.contains('incoming')) {
        reactionPicker.style.left = '40px';
      } else {
        reactionPicker.style.right = '40px';
      }
      reactionPicker.style.bottom = '-20px';
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ©
      const emojiButtons = reactionPicker.querySelectorAll('.emoji-btn');
      emojiButtons.forEach(btn => {
        btn.style.cssText = `
          background: none;
          border: none;
          font-size: 1.2rem;
          margin: 0 2px;
          cursor: pointer;
          transition: transform 0.2s;
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠ
        btn.addEventListener('click', function() {
          const emoji = this.getAttribute('data-emoji');
          sendReaction(messageId, externalId, emoji);
          reactionPicker.remove();
        });
        
        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ØªØ­ÙˆÙŠÙ…
        btn.addEventListener('mouseover', function() {
          this.style.transform = 'scale(1.3)';
        });
        
        btn.addEventListener('mouseout', function() {
          this.style.transform = 'scale(1)';
        });
      });
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      messageElem.appendChild(reactionPicker);
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ø­Ø¯Ø« Ù„Ø¥ØºÙ„Ø§Ù‚ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
      document.addEventListener('click', function closeReactionPicker(e) {
        if (!reactionPicker.contains(e.target) && !e.target.closest('.reaction-btn')) {
          reactionPicker.remove();
          document.removeEventListener('click', closeReactionPicker);
        }
      });
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„
    function sendReaction(messageId, externalId, emoji) {
      // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„
      fetch(`/crm/conversations/${conversationId}/react`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
          messageId: messageId,
          externalMessageId: externalId,
          emoji: emoji
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
          if (typeof refreshConversationDetails === 'function') {
            refreshConversationDetails();
          } else {
            // Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            addReactionToMessage(messageId, emoji, data.userId, data.username);
          }
        } else {
          alert(data.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„.');
        }
      })
      .catch(error => {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
      });
    }
    
    // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function addReactionToMessage(messageId, emoji, userId, username) {
      const messageElem = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (!messageElem) return;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
      let reactionsContainer = messageElem.querySelector('.message-reactions');
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
      if (!reactionsContainer) {
        reactionsContainer = document.createElement('div');
        reactionsContainer.className = 'message-reactions';
        messageElem.appendChild(reactionsContainer);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const reactionSpan = document.createElement('span');
      reactionSpan.className = 'reaction-emoji';
      reactionSpan.setAttribute('title', `ØªÙØ§Ø¹Ù„ Ù…Ù† ${username}`);
      reactionSpan.textContent = emoji;
      
      reactionsContainer.appendChild(reactionSpan);
    }
  });
</script>