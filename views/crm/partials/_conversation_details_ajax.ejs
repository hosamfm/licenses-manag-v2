<!-- Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø²Ø¦ÙŠ (Partial) ÙŠØ¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
<!-- ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹ -->
<script>
  // ØªØ¹Ø±ÙŠÙ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒÙ…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
  window.currentUserId = "<%= typeof user !== 'undefined' && user ? user._id : 'system' %>";
  window.currentUsername = "<%= typeof user !== 'undefined' && user ? user.username : 'Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù…' %>";
</script>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-comments me-1"></i>
        Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ <%= conversation.customerName || conversation.phoneNumber %>
      </h5>
      <span class="badge bg-primary"><%= messages.length %> Ø±Ø³Ø§Ù„Ø©</span>
    </div>
    <div class="card-body p-0" id="messageContainer" style="max-height: 500px; overflow-y: auto;">
      <% if (messages && messages.length) { %>
        <% messages.forEach((msg, index) => { %>
          <div class="message <%= msg.direction %>"
               data-message-id="<%= msg._id %>"
               data-status="<%= msg.status %>"
               <% if (msg.externalMessageId) { %> data-external-id="<%= msg.externalMessageId %>" <% } %>>
            
            <% if (msg.replyToMessageId) { %>
              <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚ØªØ¨Ø³Ø© ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø±Ø¯ -->
              <div class="replied-message">
                <% const repliedMsg = messages.find(m => m.externalMessageId === msg.replyToMessageId); %>
                <% if (repliedMsg) { %>
                  <div class="replied-content">
                    <i class="fas fa-reply"></i>
                    <span><%= repliedMsg.content.length > 50 ? repliedMsg.content.substring(0, 50) + '...' : repliedMsg.content %></span>
                  </div>
                <% } else { %>
                  <div class="replied-content text-muted">
                    <i class="fas fa-reply"></i>
                    <span>Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</span>
                  </div>
                <% } %>
              </div>
            <% } %>
            
            <div class="message-bubble <%= msg.direction === 'incoming' ? 'incoming-bubble' : 'outgoing-bubble' %>">
              <%= msg.content %>
              <div class="message-time">
                <%= new Date(msg.timestamp).toLocaleString('ar-LY') %>
                
                <% if (msg.direction === 'outgoing') { %>
                  <span class="message-status">
                    <% if (msg.status === 'sending') { %>
                      <i class="fas fa-clock text-secondary" title="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."></i>
                    <% } else if (msg.status === 'sent') { %>
                      <i class="fas fa-check text-silver" title="ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>
                    <% } else if (msg.status === 'delivered') { %>
                      <i class="fas fa-check-double text-silver" title="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"></i>
                    <% } else if (msg.status === 'read') { %>
                      <i class="fas fa-check-double text-primary" title="ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"></i>
                    <% } else if (msg.status === 'failed') { %>
                      <i class="fas fa-exclamation-triangle text-danger" title="ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>
                    <% } %>
                  </span>
                <% } %>
              </div>
            </div>
            
            <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
            <% if (msg.reactions && msg.reactions.length > 0) { %>
              <div class="message-reactions">
                <% msg.reactions.forEach(function(reaction) { %>
                  <span class="reaction-emoji" title="ØªÙØ§Ø¹Ù„ Ù…Ù† <%= reaction.sender %>">
                    <%= reaction.emoji %>
                  </span>
                <% }); %>
              </div>
            <% } %>
            
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
            <div class="message-actions">
              <button class="btn btn-sm text-muted message-action-btn reaction-btn" title="ØªÙØ§Ø¹Ù„">
                <i class="far fa-smile"></i>
              </button>
              <button class="btn btn-sm text-muted message-action-btn reply-btn" 
                      data-message-id="<%= msg._id %>" 
                      data-external-id="<%= msg.externalMessageId %>" 
                      title="Ø±Ø¯">
                <i class="fas fa-reply"></i>
              </button>
            </div>
          </div>
          <div class="clear-both"></div>
          
          <% if (index < messages.length - 1 && 
                  new Date(messages[index+1].timestamp) - new Date(msg.timestamp) > 3600000) { %>
            <div class="message-internal-note text-muted my-2" style="font-size: 0.85rem;">
              <i class="fas fa-clock me-1"></i>
              Ù…Ø±Øª <%= Math.round((new Date(messages[index+1].timestamp) - new Date(msg.timestamp)) / 3600000) %> Ø³Ø§Ø¹Ø©
            </div>
          <% } %>
        <% }) %>
      <% } else { %>
        <div class="text-center text-muted py-3">
          <i class="fas fa-comment-dots mb-3" style="font-size: 3rem; opacity: 0.2;"></i>
          <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.</p>
        </div>
      <% } %>
    </div>
  </div>
  
  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ØºÙŠØ± Ù…ØºÙ„Ù‚Ø©) -->
  <% if (conversation.status !== 'closed') { %>
    <form id="replyForm" action="/crm/conversations/<%= conversation._id %>/reply" method="POST" class="mt-3">
      <div class="mb-3">
        <label for="replyMessage" class="form-label">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯</label>
        <textarea class="form-control" id="replyMessage" name="content"
                  rows="3" required placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ... (Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„)"></textarea>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <span class="sending-indicator" id="sendingIndicator" style="display: none;">
          <i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...
        </span>
        <button type="reset" class="btn btn-outline-secondary">Ù…Ø³Ø­</button>
        <button type="submit" class="btn btn-primary" id="sendButton">
          <i class="fas fa-paper-plane me-1"></i> Ø¥Ø±Ø³Ø§Ù„
        </button>
      </div>
    </form>
  <% } else { %>
    <div class="alert alert-secondary mt-3">
      <i class="fas fa-lock me-1"></i>
      Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…ØºÙ„Ù‚Ø©ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø±Ø¯.
    </div>
  <% } %>

<!-- ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© CSS Ø¥Ø¶Ø§ÙÙŠ ÙÙŠ Ø§Ù„Ù…Ù„ÙÙŠÙ† conversations_split_ajax.ejs Ùˆ Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<style>
  .message {
    position: relative;
    margin-bottom: 15px;
    clear: both;
    max-width: 75%;
  }
  
  .message.incoming {
    float: left;
  }
  
  .message.outgoing {
    float: right;
  }
  
  .message-bubble {
    padding: 8px 12px;
    border-radius: 15px;
    position: relative;
    word-wrap: break-word;
  }
  
  .incoming-bubble {
    background-color: #e9ecef;
    border-bottom-left-radius: 5px;
  }
  
  .outgoing-bubble {
    background-color: #d4edda;
    border-bottom-right-radius: 5px;
  }
  
  .message-time {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 3px;
    text-align: right;
  }
  
  .message-actions {
    position: absolute;
    right: 5px;
    bottom: -20px;
    opacity: 0;
    transition: opacity 0.2s;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    padding: 0 5px;
    display: flex;
  }
  
  .message.incoming .message-actions {
    left: 5px;
    right: auto;
  }
  
  .message:hover .message-actions {
    opacity: 1;
  }
  
  .message-action-btn {
    padding: 0.1rem 0.3rem;
  }
  
  .replied-message {
    margin-bottom: 5px;
    padding: 5px;
    background-color: rgba(0,0,0,0.03);
    border-radius: 10px;
    font-size: 0.85rem;
  }
  
  .clear-both {
    clear: both;
  }
  
  .message-reactions {
    position: absolute;
    bottom: -15px;
    right: 10px;
    background: white;
    padding: 2px 5px;
    border-radius: 10px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  
  .message.incoming .message-reactions {
    left: 10px;
    right: auto;
  }
  
  .message-internal-note {
    text-align: center;
    padding: 5px;
    border-radius: 15px;
    clear: both;
  }
  
  .sending-indicator {
    color: #6c757d;
    display: none;
  }
  
  .sending-indicator i {
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
</style>

<!-- Ø¥Ø¶Ø§ÙØ© JavaScript Ù„ØªÙ…ÙƒÙŠÙ† ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø¯ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¸ÙŠÙØ© Ø¹Ø§Ù…Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    window.attachConversationEventListeners = function() {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø¥Ù„Ù‰ Ø¹Ù†Ø§ØµØ± DOM
      const replyForm = document.getElementById('replyForm');
      const replyMessage = document.getElementById('replyMessage');
      const sendButton = document.getElementById('sendButton');
      const sendingIndicator = document.getElementById('sendingIndicator');
      const conversationId = '<%= conversation._id %>';
      
      // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©
      let currentReplyToId = null;  // Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
      let currentReplyMessageElem = null;  // Ø¹Ù†ØµØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
      
      // ØµÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§
      let messageQueue = [];
      let isProcessing = false;  // Ù‡Ù„ Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙ Ø­Ø§Ù„ÙŠØ§Ù‹ØŸ
      
      // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
      if (replyForm) {
        replyForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø­ØªÙˆÙ‰
          const messageContent = replyMessage.value.trim();
          if (!messageContent) return;
          
          // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
          sendButton.disabled = true;
          sendingIndicator.style.display = 'inline-block';
          
          // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          const messageData = {
            content: messageContent,
            timestamp: new Date().toISOString(),
            direction: 'outgoing',
            status: 'sending',
            _id: 'temp-' + Date.now(),
            externalMessageId: null
          };
          
          // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©
          if (currentReplyToId) {
            messageData.replyToMessageId = currentReplyToId;
            messageData.replyToMessageElem = currentReplyMessageElem;
          }
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
          messageQueue.push(messageData);
          
          // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
          if (currentReplyToId) {
            addNewMessageWithReply(messageData);
          } else {
            addNewMessage(messageData);
          }
          
          // ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø£Ø³ÙÙ„
          const messageContainer = document.getElementById('messageContainer');
          if (messageContainer) {
            messageContainer.scrollTop = messageContainer.scrollHeight;
          }
          
          // Ù…Ø³Ø­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
          replyMessage.value = '';
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø±Ø¯
          resetReplyState();
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
          processMessageQueue();
        });
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
        replyMessage.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            
            if (replyMessage.value.trim()) {
              replyForm.dispatchEvent(new Event('submit'));
            }
          }
        });
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      function processMessageQueue() {
        if (isProcessing || messageQueue.length === 0) return;
        
        isProcessing = true;
        const messageData = messageQueue.shift();
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        const replyToId = messageData.replyToMessageId ? messageData.replyToMessageId : null;
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
        fetch(`/crm/conversations/<%= conversation._id %>/reply`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            content: messageData.content,
            replyToMessageId: replyToId,
            tempId: messageData._id
          })
        })
        .then(response => {
          if (!response.ok) throw new Error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
          return response.json();
        })
        .then(data => {
          console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­:', data);
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
          const tempMsgElem = document.querySelector(`.message[data-message-id="${messageData._id}"]`);
          if (tempMsgElem && data.message) {
            // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ø±Ù Ø¨Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
            tempMsgElem.setAttribute('data-message-id', data.message._id);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø¹Ø±Ù Ø®Ø§Ø±Ø¬ÙŠ
            if (data.message.externalMessageId) {
              tempMsgElem.setAttribute('data-external-id', data.message.externalMessageId);
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
            tempMsgElem.setAttribute('data-status', 'sent');
            
            // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø©
            const statusIcon = tempMsgElem.querySelector('.message-status i');
            if (statusIcon) {
              statusIcon.className = 'fas fa-check text-silver';
              statusIcon.title = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
            }
          }
          
          // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
          isProcessing = false;
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          if (sendButton) sendButton.disabled = false;
          if (sendingIndicator) sendingIndicator.style.display = 'none';
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
          if (messageQueue.length > 0) {
            processMessageQueue();
          }
        })
        .catch(error => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', error);
          
          // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙØ´Ù„
          const tempMsgElem = document.querySelector(`.message[data-message-id="${messageData._id}"]`);
          if (tempMsgElem) {
            tempMsgElem.setAttribute('data-status', 'failed');
            
            // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø­Ø§Ù„Ø©
            const statusIcon = tempMsgElem.querySelector('.message-status i');
            if (statusIcon) {
              statusIcon.className = 'fas fa-exclamation-triangle text-danger';
              statusIcon.title = 'ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„';
            }
          }
          
          // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
          isProcessing = false;
          
          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
          if (sendButton) sendButton.disabled = false;
          if (sendingIndicator) sendingIndicator.style.display = 'none';
          
          // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
          window.showToast && window.showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'danger');
          
          // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
          if (messageQueue.length > 0) {
            processMessageQueue();
          }
        });
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      function addNewMessage(messageData) {
        const messageContainer = document.getElementById('messageContainer');
        if (!messageContainer) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.direction}`;
        messageDiv.setAttribute('data-message-id', messageData._id || 'temp-' + Date.now());
        messageDiv.setAttribute('data-status', messageData.status || 'sending');
        
        if (messageData.externalMessageId) {
          messageDiv.setAttribute('data-external-id', messageData.externalMessageId);
        }
        
        let statusIcon = '';
        if (messageData.direction === 'outgoing') {
          if (messageData.status === 'sending') {
            statusIcon = '<i class="fas fa-clock text-secondary" title="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."></i>';
          } else if (messageData.status === 'sent') {
            statusIcon = '<i class="fas fa-check text-silver" title="ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>';
          } else if (messageData.status === 'delivered') {
            statusIcon = '<i class="fas fa-check-double text-silver" title="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"></i>';
          } else if (messageData.status === 'read') {
            statusIcon = '<i class="fas fa-check-double text-primary" title="ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"></i>';
          } else if (messageData.status === 'failed') {
            statusIcon = '<i class="fas fa-exclamation-triangle text-danger" title="ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>';
          }
        }
        
        messageDiv.innerHTML = `
          <div class="message-bubble ${messageData.direction === 'incoming' ? 'incoming-bubble' : 'outgoing-bubble'}">
            ${messageData.content}
            <div class="message-time">
              ${new Date(messageData.timestamp).toLocaleString('ar-LY')}
              ${messageData.direction === 'outgoing' ? `<span class="message-status">${statusIcon}</span>` : ''}
            </div>
          </div>
          
          <div class="message-actions">
            <button class="btn btn-sm text-muted message-action-btn reaction-btn" title="ØªÙØ§Ø¹Ù„">
              <i class="far fa-smile"></i>
            </button>
            <button class="btn btn-sm text-muted message-action-btn reply-btn" 
                    data-message-id="${messageData._id}" 
                    data-external-id="${messageData.externalMessageId || ''}" 
                    title="Ø±Ø¯">
              <i class="fas fa-reply"></i>
            </button>
          </div>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        messageContainer.appendChild(messageDiv);
        
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± clear-both
        const clearDiv = document.createElement('div');
        clearDiv.className = 'clear-both';
        messageContainer.appendChild(clearDiv);
        
        // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø±Ø¯
        setupMessageActions(messageDiv);
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù‚ØªØ¨Ø§Ø³ Ø±Ø¯
      function addNewMessageWithReply(messageData) {
        const messageContainer = document.getElementById('messageContainer');
        if (!messageContainer) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.direction}`;
        messageDiv.setAttribute('data-message-id', messageData._id);
        messageDiv.setAttribute('data-status', messageData.status || 'sending');
        
        if (messageData.externalMessageId) {
          messageDiv.setAttribute('data-external-id', messageData.externalMessageId);
        }
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù‚ØªØ¨Ø³Ø©
        let repliedContent = 'Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø©';
        let repliedMessageElem = null;
        
        if (messageData.replyToMessageId) {
          repliedMessageElem = document.querySelector(`.message[data-message-id="${messageData.replyToMessageId}"]`);
          
          if (repliedMessageElem) {
            const contentElem = repliedMessageElem.querySelector('.message-bubble');
            if (contentElem) {
              repliedContent = contentElem.textContent.trim();
              
              // Ø§Ù‚ØªØµØ§Ø± Ø·ÙˆÙ„ Ø§Ù„Ù†Øµ
              if (repliedContent.length > 50) {
                repliedContent = repliedContent.substring(0, 50) + '...';
              }
            }
          }
        }
        
        let statusIcon = '';
        if (messageData.direction === 'outgoing') {
          if (messageData.status === 'sending') {
            statusIcon = '<i class="fas fa-clock text-secondary" title="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„..."></i>';
          } else if (messageData.status === 'sent') {
            statusIcon = '<i class="fas fa-check text-silver" title="ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>';
          } else if (messageData.status === 'delivered') {
            statusIcon = '<i class="fas fa-check-double text-silver" title="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"></i>';
          } else if (messageData.status === 'read') {
            statusIcon = '<i class="fas fa-check-double text-primary" title="ØªÙ… Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©"></i>';
          } else if (messageData.status === 'failed') {
            statusIcon = '<i class="fas fa-exclamation-triangle text-danger" title="ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„"></i>';
          }
        }
        
        messageDiv.innerHTML = `
          <div class="replied-message">
            <div class="replied-content">
              <i class="fas fa-reply"></i>
              <span>${repliedContent}</span>
            </div>
          </div>
          
          <div class="message-bubble ${messageData.direction === 'incoming' ? 'incoming-bubble' : 'outgoing-bubble'}">
            ${messageData.content}
            <div class="message-time">
              ${new Date(messageData.timestamp).toLocaleString('ar-LY')}
              ${messageData.direction === 'outgoing' ? `<span class="message-status">${statusIcon}</span>` : ''}
            </div>
          </div>
          
          <div class="message-actions">
            <button class="btn btn-sm text-muted message-action-btn reaction-btn" title="ØªÙØ§Ø¹Ù„">
              <i class="far fa-smile"></i>
            </button>
            <button class="btn btn-sm text-muted message-action-btn reply-btn" 
                    data-message-id="${messageData._id}" 
                    data-external-id="${messageData.externalMessageId || ''}" 
                    title="Ø±Ø¯">
              <i class="fas fa-reply"></i>
            </button>
          </div>
        `;
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        messageContainer.appendChild(messageDiv);
        
        // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± clear-both
        const clearDiv = document.createElement('div');
        clearDiv.className = 'clear-both';
        messageContainer.appendChild(clearDiv);
        
        // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø±Ø¯
        setupMessageActions(messageDiv);
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      function setupMessageActions(messageElem) {
        if (!messageElem) return;
        
        // Ø²Ø± Ø§Ù„Ø±Ø¯
        const replyButton = messageElem.querySelector('.reply-btn');
        if (replyButton) {
          replyButton.addEventListener('click', function() {
            const messageId = this.getAttribute('data-message-id');
            const externalId = this.getAttribute('data-external-id');
            showReplyForm(messageId, externalId, messageElem);
          });
        }
        
        // Ø²Ø± Ø§Ù„ØªÙØ§Ø¹Ù„
        const reactionButton = messageElem.querySelector('.reaction-btn');
        if (reactionButton) {
          reactionButton.addEventListener('click', function() {
            const messageId = messageElem.getAttribute('data-message-id');
            const externalId = messageElem.getAttribute('data-external-id');
            showReactionPicker(messageId, externalId);
          });
        }
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
      const allMessages = document.querySelectorAll('.message');
      allMessages.forEach(message => {
        setupMessageActions(message);
      });
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ÙŠÙ†Ø©
      function showReplyForm(messageId, externalId, messageElem) {
        if (!messageElem || !messageId) return;
        
        // ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§
        currentReplyToId = messageId;
        currentReplyMessageElem = messageElem;
        
        // Ø¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯
        let replyIndicator = document.getElementById('replyIndicator');
        
        if (!replyIndicator) {
          replyIndicator = document.createElement('div');
          replyIndicator.id = 'replyIndicator';
          replyIndicator.className = 'reply-indicator alert alert-info d-flex justify-content-between align-items-center py-2 mb-2';
          
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶
          const messageContent = messageElem.querySelector('.message-bubble').textContent.trim().substring(0, 50);
          
          replyIndicator.innerHTML = `
            <div>
              <i class="fas fa-reply me-1"></i>
              <small>Ø±Ø¯ Ø¹Ù„Ù‰: ${messageContent}${messageContent.length > 50 ? '...' : ''}</small>
            </div>
            <button type="button" class="btn btn-sm text-secondary cancel-reply-btn">
              <i class="fas fa-times"></i>
            </button>
          `;
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¤Ø´Ø± Ù‚Ø¨Ù„ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
          if (replyForm) {
            replyForm.insertBefore(replyIndicator, replyForm.firstChild);
          }
          
          // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯Ø« Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø¯
          const cancelButton = replyIndicator.querySelector('.cancel-reply-btn');
          if (cancelButton) {
            cancelButton.addEventListener('click', resetReplyState);
          }
        } else {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
          const messageContent = messageElem.querySelector('.message-bubble').textContent.trim().substring(0, 50);
          replyIndicator.querySelector('small').innerHTML = `Ø±Ø¯ Ø¹Ù„Ù‰: ${messageContent}${messageContent.length > 50 ? '...' : ''}`;
        }
        
        // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        if (replyMessage) {
          replyMessage.focus();
        }
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø¯
      function resetReplyState() {
        currentReplyToId = null;
        currentReplyMessageElem = null;
        
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¤Ø´Ø± Ø§Ù„Ø±Ø¯ Ø¥Ù† ÙˆØ¬Ø¯
        const replyIndicator = document.getElementById('replyIndicator');
        if (replyIndicator) {
          replyIndicator.remove();
        }
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
      function showReactionPicker(messageId, externalId) {
        if (!messageId) return;
        
        // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù„Ù‡Ø§
        const messageElem = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (!messageElem) return;
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        let reactionPicker = document.getElementById('reactionPicker');
        
        if (!reactionPicker) {
          reactionPicker = document.createElement('div');
          reactionPicker.id = 'reactionPicker';
          reactionPicker.className = 'reaction-picker';
          
          const reactions = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ‘'];
          
          let buttonsHTML = '';
          reactions.forEach(emoji => {
            buttonsHTML += `<button class="reaction-emoji-btn" data-emoji="${emoji}">${emoji}</button>`;
          });
          
          reactionPicker.innerHTML = buttonsHTML;
          document.body.appendChild(reactionPicker);
          
          // Ø¥Ø¶Ø§ÙØ© Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
          reactionPicker.querySelectorAll('.reaction-emoji-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              const emoji = this.getAttribute('data-emoji');
              sendReaction(messageId, emoji, externalId);
              reactionPicker.remove();
            });
          });
          
          // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø¢Ø®Ø±
          document.addEventListener('click', function closeReactionPicker(e) {
            if (!reactionPicker.contains(e.target) && 
                !e.target.classList.contains('reaction-btn') && 
                !e.target.closest('.reaction-btn')) {
              reactionPicker.remove();
              document.removeEventListener('click', closeReactionPicker);
            }
          });
        }
        
        // ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ù…Ù†ØªÙ‚ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø±Ø³Ø§Ù„Ø©
        const reactionBtn = messageElem.querySelector('.reaction-btn');
        if (reactionBtn) {
          const rect = reactionBtn.getBoundingClientRect();
          const isRTL = document.dir === 'rtl';
          
          if (isRTL) {
            reactionPicker.style.right = `${rect.right}px`;
          } else {
            reactionPicker.style.left = `${rect.left}px`;
          }
          
          reactionPicker.style.top = `${rect.bottom + window.scrollY + 5}px`;
        }
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ ØªÙØ§Ø¹Ù„
      function sendReaction(messageId, emoji, externalId) {
        if (!messageId || !emoji) return;
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
        fetch(`/crm/conversations/<%= conversation._id %>/reaction`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: JSON.stringify({
            messageId: messageId,
            externalMessageId: externalId,
            emoji: emoji,
            senderId: window.currentUserId,
            senderName: window.currentUsername
          })
        })
        .then(response => {
          if (!response.ok) throw new Error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„');
          return response.json();
        })
        .then(data => {
          console.log('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¨Ù†Ø¬Ø§Ø­:', data);
          
          // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø©
          addReactionToMessage(messageId, emoji, window.currentUserId, window.currentUsername);
        })
        .catch(error => {
          console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„:', error);
          window.showToast && window.showToast('ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.', 'danger');
        });
      }
      
      // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¶Ø§ÙØ© ØªÙØ§Ø¹Ù„ Ø¥Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      function addReactionToMessage(messageId, emoji, userId, username) {
        const messageElem = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (!messageElem) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        let reactionsDiv = messageElem.querySelector('.message-reactions');
        
        if (!reactionsDiv) {
          reactionsDiv = document.createElement('div');
          reactionsDiv.className = 'message-reactions';
          
          // Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¯ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©
          const bubbleDiv = messageElem.querySelector('.message-bubble');
          if (bubbleDiv) {
            bubbleDiv.insertAdjacentElement('afterend', reactionsDiv);
          } else {
            messageElem.appendChild(reactionsDiv);
          }
        }
        
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„
        const reactionSpan = document.createElement('span');
        reactionSpan.className = 'reaction-emoji';
        reactionSpan.title = `ØªÙØ§Ø¹Ù„ Ù…Ù† ${username}`;
        reactionSpan.textContent = emoji;
        
        reactionsDiv.appendChild(reactionSpan);
      }
    };
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙˆØ¸ÙŠÙØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ AJAX
    window.attachConversationEventListeners();
  });
</script>