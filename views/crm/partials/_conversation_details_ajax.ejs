<!-- هذا الملف الجزئي (Partial) يعرض تفاصيل المحادثة والرسائل -->
<!-- تعريف متغيرات المستخدم عالمياً -->
<script>
  // تعريف معلومات المستخدم كمتغيرات عامة
  window.currentUserId = "<%= typeof user !== 'undefined' && user ? user._id : 'system' %>";
  window.currentUsername = "<%= typeof user !== 'undefined' && user ? user.username : 'مستخدم النظام' %>";
</script>


<!-- دوال مساعدة محلية -->
<script>
  // دالة لتنسيق الوقت بشكل مقروء
  function formatTime(timestamp) {
    if (!timestamp) return '';
    
    const date = new Date(timestamp);
    return date.toLocaleString('ar-LY', { 
      hour: '2-digit', 
      minute: '2-digit',
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }
  
  // دالة لعرض نص حالة الرسالة
  function getStatusText(status) {
    switch (status) {
      case 'sending':
        return 'جاري الإرسال...';
      case 'sent':
        return 'تم الإرسال';
      case 'delivered':
        return 'تم التسليم';
      case 'read':
        return 'تم القراءة';
      case 'failed':
        return 'فشل الإرسال';
      default:
        return status || 'غير معروف';
    }
  }
  
  // تسجيل مشاهدة الرسالة
  window.markMessageAsRead = function(messageId, externalMessageId) {
    // استخدام الـ Socket لإرسال إخطار قراءة الرسالة
    if (window.socket && messageId) {
      const actualMessageId = externalMessageId || messageId;
      window.socket.emit('message_read', {
        messageId: actualMessageId,
        userId: window.currentUserId,
        username: window.currentUsername
      });
    }
  }
  
  // جلب قائمة قراء الرسالة
  window.getMessageReaders = function(messageId, externalMessageId) {
    return new Promise((resolve, reject) => {
      const actualMessageId = externalMessageId || messageId;
      $.ajax({
        url: `/api/messages/${actualMessageId}/readers`,
        method: 'GET',
        success: function(response) {
          resolve(response.readers || []);
        },
        error: function(error) {
          console.error('فشل في جلب قائمة القراء:', error);
          reject(error);
        }
      });
    });
  }
  
  // عرض قائمة القراء
  window.showMessageReaders = function(messageId, externalMessageId, buttonElement) {
    const $button = $(buttonElement);
    const $loadingIcon = $('<i class="fas fa-spinner fa-spin"></i>');
    
    // عرض أيقونة التحميل
    $button.html($loadingIcon);
    
    window.getMessageReaders(messageId, externalMessageId)
      .then(readers => {
        // إعادة الأيقونة الأصلية
        $button.html('<i class="fas fa-eye"></i>');
        
        // تحضير محتوى قائمة القراء
        let readersList = '';
        if (readers && readers.length > 0) {
          readersList = '<ul class="list-group">';
          readers.forEach(reader => {
            // تنسيق تاريخ القراءة
            const readTime = reader.readAt ? formatTime(reader.readAt) : 'تاريخ غير معروف';
            readersList += `<li class="list-group-item d-flex justify-content-between align-items-center">
              <span>${reader.username || 'مستخدم غير معروف'}</span>
              <small class="text-muted">${readTime}</small>
            </li>`;
          });
          readersList += '</ul>';
        } else {
          readersList = '<div class="text-center p-3">لم يقرأ أحد هذه الرسالة بعد</div>';
        }
        
        // عرض النافذة المنبثقة مع قائمة القراء
        const $popover = $button.popover({
          title: 'قرأ هذه الرسالة',
          content: readersList,
          html: true,
          placement: 'left',
          trigger: 'manual',
          template: '<div class="popover readers-popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>'
        });
        
        $button.popover('show');
        
        // إغلاق القائمة عند النقر في أي مكان آخر
        $(document).one('click', function(e) {
          if (!$(e.target).is($button) && $(e.target).closest('.popover').length === 0) {
            $button.popover('hide');
          }
        });
      })
      .catch(error => {
        // إعادة الأيقونة الأصلية عند حدوث خطأ
        $button.html('<i class="fas fa-eye"></i>');
        console.error('فشل في عرض قائمة القراء:', error);
      });
  }
</script>

<div class="card shadow-sm border-0">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 d-flex align-items-center">
        <i class="fas fa-comments me-2 text-primary"></i>
        <span>المحادثة مع <%= conversation.customerName || conversation.phoneNumber %></span>
        <% if (conversation.status === 'closed') { %>
          <span class="badge bg-secondary ms-2 conversation-status-badge"><i class="fas fa-lock me-1"></i> مغلقة</span>
        <% } else if (conversation.status === 'assigned') { %>
          <span class="badge bg-info ms-2 conversation-status-badge"><i class="fas fa-user-check me-1"></i> مسندة</span>
        <% } else { %>
          <span class="badge bg-success ms-2 conversation-status-badge"><i class="fas fa-door-open me-1"></i> مفتوحة</span>
        <% } %>
      </h5>
      <div class="conversation-actions">
        <% if (conversation.status !== 'closed') { %>
          <button class="btn btn-danger close-conversation-btn" 
                  data-conversation-id="<%= conversation._id %>" 
                  title="إغلاق المحادثة">
            <i class="fas fa-lock me-1"></i> إغلاق
          </button>
        <% } else { %>
          <button class="btn btn-success reopen-conversation-btn" 
                  data-conversation-id="<%= conversation._id %>" 
                  title="إعادة فتح المحادثة">
            <i class="fas fa-lock-open me-1"></i> إعادة فتح
          </button>
        <% } %>
        <span class="badge bg-primary ms-2"><i class="fas fa-comments me-1"></i> <%= messages.length %> رسالة</span>
      </div>
    </div>
    <div class="card-body p-0" id="messageContainer" style="max-height: 500px; overflow-y: auto;">
      <% if (conversation.status === 'closed') { %>
        <div class="alert alert-info m-3 text-center">
          <i class="fas fa-info-circle me-1"></i> هذه المحادثة مغلقة.
          <br>
          <small>سيتم إعادة فتحها تلقائيًا إذا أرسل العميل رسالة جديدة.</small>
        </div>
      <% } %>
      <div class="message-container-wrapper">
        <% if (messages && messages.length) { %>
            <% messages.forEach(function(message) { %>
              <div class="message <%= message.direction %>" 
                  data-message-id="<%= message._id %>" 
                  data-status="<%= message.status || 'sent' %>"
                  data-observed="false"
                  <%= message.externalMessageId ? `data-external-id="${message.externalMessageId}"` : '' %>>
                
                <% if (message.replyToMessageId) { 
                  // البحث عن الرسالة المرد عليها
                  let repliedMsg = null;
                  for (let i = 0; i < messages.length; i++) {
                    if (messages[i]._id.toString() === message.replyToMessageId.toString() || 
                        (messages[i].externalMessageId && messages[i].externalMessageId === message.replyToMessageId)) {
                      repliedMsg = messages[i];
                      break;
                    }
                  }
                %>
                  <div class="replied-message">
                    <div class="replied-content">
                      <i class="fas fa-reply"></i>
                      <span><%= repliedMsg ? 
                        (repliedMsg.content ? repliedMsg.content.substring(0, 50) + (repliedMsg.content.length > 50 ? '...' : '') : 'محتوى وسائط') : 
                        `رد على رسالة محذوفة` %></span>
                    </div>
                  </div>
                <% } %>
                
                <div class="message-bubble <%= message.direction === 'incoming' ? 'incoming-bubble' : (message.direction === 'internal' ? 'internal-note-bubble' : 'outgoing-bubble') %> <%= message.mediaType ? 'message-with-media' : '' %>">
                  <% if (message.direction === 'internal') { %>
                    <%- include('_internal_note', { note: message }) %>
                  <% } else { %>
                    <% if (message.direction === 'outgoing') { %>
                    <!-- إضافة اسم المرسل فقط للرسائل الصادرة -->
                    <div class="message-sender">
                      <%= message.metadata && message.metadata.senderInfo 
                        ? message.metadata.senderInfo.username || message.metadata.senderInfo.full_name || 'مستخدم غير معروف'
                        : message.sentByUsername || 'مستخدم غير معروف' %>
                    </div>
                    <% } %>
                    
                    <!-- عرض الوسائط -->
                    <% if (message.mediaType) { %>
                      <%- include('_message_media', { message: message }) %>
                    <% } %>
                    
                    <% if (message.content && message.content.trim() !== '') { %>
                      <div class="message-text <%= message.mediaType ? 'with-media' : '' %>">
                        <%= message.content %>
                      </div>
                    <% } %>
                    
                    <div class="message-meta">
                      <span class="message-time" title="<%= new Date(message.timestamp || message.createdAt).toLocaleString() %>">
                        <%= new Date(message.timestamp || message.createdAt).toLocaleString('ar-LY', { hour: '2-digit', minute: '2-digit' }) %>
                      </span>
                      
                      <% if (message.direction === 'outgoing') { %>
                        <span class="message-status" title="حالة الرسالة: <%= message.status || 'sent' %>">
                          <% if (message.status === 'sent') { %>
                            <i class="fas fa-check text-secondary"></i>
                          <% } else if (message.status === 'delivered') { %>
                            <i class="fas fa-check-double text-secondary"></i>
                          <% } else if (message.status === 'read') { %>
                            <i class="fas fa-check-double text-primary"></i>
                          <% } else if (message.status === 'failed') { %>
                            <i class="fas fa-exclamation-circle text-danger"></i>
                          <% } else { /* sending or undefined */ %>
                            <i class="fas fa-clock text-secondary"></i>
                          <% } %>
                        </span>
                      <% } %>
                      
                      <!-- إضافة عدد القراء للرسائل الواردة -->
                      <% if (message.direction === 'incoming' && message.readBy && message.readBy.length > 0) { %>
                        <span class="reader-count" title="قرأها <%= message.readBy.length %> مستخدم/ين">
                          (<%= message.readBy.length %>)
                        </span>
                      <% } %>
                    </div>
                  <% } %>
                </div>
                
                <% if (message.reactions && message.reactions.length > 0 && message.direction !== 'internal') { %>
                  <div class="message-reactions">
                    <% message.reactions.forEach(function(reaction) { %>
                      <span class="reaction-emoji" title="تفاعل من <%= reaction.sender %>">
                        <%= reaction.emoji %>
                      </span>
                    <% }); %>
                  </div>
                <% } %>
                
                <!-- أزرار التفاعل مع الرسالة (باستثناء الملاحظات الداخلية) -->
                <% if (message.direction !== 'internal') { %>
                  <div class="message-actions">
                    <button type="button" class="btn btn-sm text-muted message-action-btn reaction-btn" title="تفاعل">
                      <i class="far fa-smile"></i>
                    </button>
                    <button type="button" class="btn btn-sm text-muted message-action-btn reply-btn" 
                            data-message-id="<%= message._id %>" 
                            data-external-id="<%= message.externalMessageId || '' %>" 
                            title="رد">
                      <i class="fas fa-reply"></i>
                    </button>
                    
                    <!-- زر عرض قائمة القراء للرسائل الواردة فقط -->
                    <% if (message.direction === 'incoming') { %>
                    <button type="button" class="btn btn-sm text-muted message-action-btn readers-btn" 
                            data-message-id="<%= message._id %>" 
                            data-external-id="<%= message.externalMessageId || '' %>" 
                            title="قائمة القراء">
                      <i class="fas fa-eye"></i>
                    </button>
                    <% } %>
                    
                    <% if (message.direction === 'outgoing') { %>
                    <button type="button" class="btn btn-sm text-muted message-action-btn delete-btn" 
                            data-message-id="<%= message._id %>" 
                            data-external-id="<%= message.externalMessageId || '' %>" 
                            title="حذف">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                    <% } %>
                  </div>
                <% } %>
              </div>
            <% }); %>
        <% } else { %>
          <div class="text-center p-5">
            <div class="empty-conversation">
              <i class="far fa-comments"></i>
              <p>لا توجد رسائل في هذه المحادثة حتى الآن.</p>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
  
  <!-- نموذج إرسال الرد (إذا كانت المحادثة غير مغلقة) -->
  <% if (conversation.status !== 'closed') { %>
    <!-- النموذج مع الاعتماد على دالة sendReply المتوفرة من ملف conversation-utils.js -->
    <form id="replyForm" class="mt-3" onsubmit="window.sendReply(event)">
      <input type="hidden" id="conversationId" value="<%= conversation._id %>">
      <div class="mb-3">
        <label for="replyMessage" class="form-label">إرسال رد</label>
        <div class="position-relative message-input-container">
          <textarea class="form-control message-input" id="replyMessage" name="content"
                rows="3" placeholder="اكتب رسالتك... (Enter للإرسال)" 
                onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); window.sendReply(event); }"></textarea>
          <div class="message-input-actions">
            <button type="button" class="btn btn-link text-secondary" id="attachMediaBtn" title="إرفاق ملف">
              <i class="fas fa-paperclip"></i>
            </button>
            <input type="file" class="d-none" id="mediaFile" name="mediaFile">
          </div>
        </div>
      </div>

      <div id="mediaPreview" class="media-preview mt-2" style="display: none;">
        <div class="card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <i class="fas fa-paperclip me-2"></i>
              <span id="mediaFileName">اسم الملف</span>
              <input type="hidden" id="mediaId" name="mediaId">
              <input type="hidden" id="mediaType" name="mediaType">
              <input type="hidden" id="uploadMediaType" name="mediaType" value="auto">
              <input type="hidden" id="uploadConversationId" name="conversationId" value="<%= conversation._id %>">
              <button type="button" class="btn btn-sm btn-danger ms-auto" onclick="window.clearMediaAttachment()">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="upload-progress mt-2" style="display: none;">
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <span class="sending-indicator" id="sendingIndicator" style="display: none;">
          <i class="fas fa-circle-notch fa-spin"></i> جاري الإرسال...
        </span>
        <div class="reply-form-actions">
          <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('replyMessage').value = ''">مسح</button>
          <button type="submit" class="btn btn-primary" id="sendButton">
            <i class="fas fa-paper-plane me-1"></i> إرسال
          </button>
        </div>
      </div>
    </form>
    
    <!-- نافذة معاينة الوسائط -->
    <div id="mediaPreviewModal" class="modal fade" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">معاينة الوسائط</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
          </div>
          <div class="modal-body text-center" id="mediaPreviewContent">
            <!-- سيتم إضافة محتوى الوسائط هنا ديناميكياً -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            <a href="#" class="btn btn-primary" id="downloadMediaBtn" download>تنزيل</a>
          </div>
        </div>
      </div>
    </div>
  <% } else { %>
    <div class="alert alert-secondary mt-3">
      <i class="fas fa-lock me-1"></i>
      المحادثة مغلقة، لا يمكن الرد.
    </div>
  <% } %>
  
  <!-- جافاسكريبت لعمل التصفح بالصفحات وتتبع ظهور الرسائل -->
  <script>
    $(document).ready(function() {
      // تأكد من وجود اتصال سوكيت
      if (typeof window.socket === 'undefined' && typeof io !== 'undefined') {
        window.socket = io();
        console.log('تم تهيئة اتصال Socket.io');
        
        // توصيل بغرفة المحادثة الحالية
        const conversationId = $('#conversationId').val();
        if (conversationId) {
          window.socket.emit('join', { room: `conversation-${conversationId}` });
          console.log('تم الانضمام إلى غرفة المحادثة:', conversationId);
        }
      }
      
      // ربط أحداث النقر بدلاً من استخدام onclick
      $(document).on('click', '.reaction-btn', function() {
        const messageId = $(this).closest('.message').data('message-id');
        const externalId = $(this).closest('.message').data('external-id') || '';
        window.showReactionPicker(messageId, externalId, this);
      });
      
      $(document).on('click', '.reply-btn', function() {
        const messageId = $(this).data('message-id');
        const externalId = $(this).data('external-id') || '';
        window.showReplyForm(messageId, externalId, $(this).closest('.message'));
      });
      
      $(document).on('click', '.readers-btn', function() {
        const messageId = $(this).data('message-id');
        const externalId = $(this).data('external-id') || '';
        window.showMessageReaders(messageId, externalId, this);
      });
      
      $(document).on('click', '.delete-btn', function() {
        const messageId = $(this).data('message-id');
        const externalId = $(this).data('external-id') || '';
        window.confirmDeleteMessage(messageId, externalId);
      });
      
      // استدعاء للصفحة التالية من الرسائل
      $('.load-more-messages').click(function() {
        const $button = $(this);
        const conversationId = $('.conversation-detail-wrapper').data('conversation-id');
        const currentPage = parseInt($button.data('current-page'));
        const nextPage = currentPage + 1;
        
        // تغيير حالة الزر
        $button.prop('disabled', true).html('<i class="fa fa-spinner fa-spin"></i> جاري التحميل...');
        
        // طلب الصفحة التالية من الرسائل
        $.ajax({
          url: `/crm/conversations/ajax/details/${conversationId}?page=${nextPage}`,
          type: 'GET',
          success: function(response) {
            // استخراج الرسائل الجديدة فقط من الاستجابة
            const $newResponse = $(response);
            const $newMessages = $newResponse.find('.message');
            
            // إضافة الرسائل الجديدة في بداية قائمة الرسائل (لأنها الأقدم)
            $('#messageContainer').prepend($newMessages);
            
            // تحديث زر التحميل أو إخفائه إذا وصلنا لنهاية الرسائل
            const hasMore = $newResponse.find('.load-more-messages').length > 0;
            if (hasMore) {
              $button
                .prop('disabled', false)
                .html(`تحميل المزيد من الرسائل (${nextPage}/${$button.data('total-pages')})`)
                .data('current-page', nextPage);
            } else {
              $button.parent().remove(); // إزالة الزر إذا وصلنا للنهاية
            }
            
            // تفعيل المشغلات للوسائط الجديدة
            if (window.setupAudioPlayers) {
              window.setupAudioPlayers();
            }
            
            // تفعيل مراقبة ظهور الرسائل للرسائل الجديدة
            setupMessageObservers();
          },
          error: function() {
            $button.prop('disabled', false).html('حدث خطأ أثناء التحميل. حاول مرة أخرى.');
          }
        });
      });
      
      // إعداد مراقب التقاطع (Intersection Observer) لتسجيل مشاهدة الرسائل
      function setupMessageObservers() {
        // إنشاء كائن مراقب التقاطع
        const messageObserver = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const $message = $(entry.target);
              const messageId = $message.data('message-id');
              const externalId = $message.data('external-id');
              const direction = $message.hasClass('incoming') ? 'incoming' : 'outgoing';
              const isObserved = $message.data('observed') === true;
              
              // تسجيل مشاهدة الرسائل الواردة فقط ولمرة واحدة
              if (direction === 'incoming' && !isObserved) {
                window.markMessageAsRead(messageId, externalId);
                $message.data('observed', true);
              }
              
              // إيقاف مراقبة الرسالة بعد تسجيلها
              messageObserver.unobserve(entry.target);
            }
          });
        }, {
          // تحديد نسبة الظهور المطلوبة لتسجيل المشاهدة (100% تعني أن الرسالة يجب أن تظهر بالكامل)
          threshold: 0.8
        });
        
        // تفعيل المراقبة على جميع الرسائل الواردة
        $('.message.incoming').each(function() {
          messageObserver.observe(this);
        });
      }
      
      // تحديد سلوك التمرير - عرض أحدث الرسائل في الأسفل
      function scrollToLatestMessage(behavior = 'auto') {
        const messageContainer = document.getElementById('messageContainer');
        if (messageContainer) {
          messageContainer.scrollTop = messageContainer.scrollHeight;
        }
      }
      
      // ترتيب الرسائل بحيث تظهر أحدث رسالة في الأسفل عند تحميل الصفحة
      scrollToLatestMessage();
      
      // تفعيل مراقبة ظهور الرسائل عند تحميل الصفحة
      setupMessageObservers();
      
      // استماع للرسائل الجديدة وتحديث الواجهة
      if (window.socket) {
        window.socket.on('new_message', function(message) {
          // تحديث واجهة المستخدم عند وصول رسالة جديدة
          // تنفيذ التحديث دون تمرير تلقائي
          
          // الانتظار قليلاً ثم تفعيل مراقبة ظهور الرسائل الجديدة
          setTimeout(setupMessageObservers, 500);
        });
        
        // استماع لتحديثات قراءة الرسائل
        window.socket.on('message_read_update', function(data) {
          // تحديث واجهة المستخدم لإظهار أن الرسالة تمت قراءتها
          const messageId = data.messageId;
          const $message = $(`[data-message-id="${messageId}"], [data-external-id="${messageId}"]`);
          
          if ($message.length > 0) {
            // تحديث العدد إذا كان موجوداً
            let $readerCount = $message.find('.reader-count');
            if ($readerCount.length === 0) {
              // إنشاء عنصر جديد إذا لم يكن موجوداً
              $readerCount = $('<span class="reader-count"></span>');
              $message.find('.message-meta').append($readerCount);
            }
            
            // تحديث العدد استناداً إلى البيانات المستلمة
            $readerCount.text(`(${data.readerCount || 1})`);
            $readerCount.attr('title', `قرأها ${data.readerCount || 1} مستخدم/ين`);
          }
        });
      }
    });
  </script>

<!-- أنماط خاصة بهذه الصفحة -->
<style>
.message-container {
  min-height: 150px;
  max-height: 400px;
  overflow-y: auto;
  scroll-behavior: smooth;
  position: relative;
}

.message-actions {
  display: none;
  position: absolute;
  right: 5px;
  bottom: -30px;
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 20px;
  padding: 2px 8px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  z-index: 10;
  transition: all 0.2s ease;
}

.message:hover .message-actions {
  display: flex;
}

.message-action-btn {
  border: none;
  background: transparent;
  padding: 4px 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
  color: #6c757d;
}

.message-action-btn:hover {
  color: #0d6efd;
}

.reader-count {
  font-size: 0.75rem;
  color: #6c757d;
  margin-left: 0.5rem;
}

.readers-popover {
  max-width: 250px;
}

.readers-popover .list-group-item {
  padding: 0.5rem 0.75rem;
  font-size: 0.9rem;
}

.clear-both {
  clear: both;
}
</style>