<!-- هذا الملف الجزئي (Partial) يعرض تفاصيل المحادثة والرسائل -->
<!-- تعريف متغيرات المستخدم عالمياً -->
<script>
  // تعريف معلومات المستخدم كمتغيرات عامة
  window.currentUserId = "<%= typeof user !== 'undefined' && user ? user._id : 'system' %>";
  window.currentUsername = "<%= typeof user !== 'undefined' && user ? user.username : 'مستخدم النظام' %>";
</script>

<!-- استدعاء ملف المساعدة للمحادثات -->
<script src="/js/conversation-utils.js"></script>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-comments me-1"></i>
        المحادثة مع <%= conversation.customerName || conversation.phoneNumber %>
      </h5>
      <span class="badge bg-primary"><%= messages.length %> رسالة</span>
    </div>
    <div class="card-body p-0" id="messageContainer" style="max-height: 500px; overflow-y: auto;">
      <% if (messages && messages.length) { %>
        <% messages.forEach((msg, index) => { %>
          <div class="message <%= msg.direction %>"
               data-message-id="<%= msg._id %>"
               data-status="<%= msg.status %>"
               <% if (msg.externalMessageId) { %> data-external-id="<%= msg.externalMessageId %>" <% } %>>
            
            <% if (msg.replyToMessageId) { %>
              <!-- عرض الرسالة المقتبسة في حالة وجود رد -->
              <div class="replied-message">
                <% 
                  // البحث عن الرسالة التي تم الرد عليها باستخدام المعرف الخارجي أو الداخلي
                  const repliedMsg = messages.find(m => 
                    (m.externalMessageId && m.externalMessageId === msg.replyToMessageId) || 
                    (m._id && m._id.toString() === msg.replyToMessageId)
                  ); 
                %>
                <% if (repliedMsg) { %>
                  <div class="replied-content">
                    <i class="fas fa-reply"></i>
                    <span><%= repliedMsg.content.length > 50 ? repliedMsg.content.substring(0, 50) + '...' : repliedMsg.content %></span>
                  </div>
                <% } else { %>
                  <div class="replied-content text-muted">
                    <i class="fas fa-reply"></i>
                    <span>رد على رسالة غير موجودة</span>
                    <small class="text-muted d-block">(المعرف: <%= msg.replyToMessageId.substring(0, 10) %>...)</small>
                  </div>
                <% } %>
              </div>
            <% } %>
            
            <div class="message-bubble <%= msg.direction === 'incoming' ? 'incoming-bubble' : 'outgoing-bubble' %>">
              <!-- عرض المحتوى حسب نوع الرسالة -->
              <% if (msg.mediaType) { %>
                <!-- إذا كانت الرسالة تحتوي على ملف وسائط -->
                <% 
                  // تجهيز رابط الوسائط من fileDetails إذا كان موجوداً
                  let mediaUrl = '';
                  let fileName = '';
                  let fileSize = 0;
                  let mimeType = '';
                  
                  if (msg.fileDetails && msg.fileDetails.publicUrl) {
                    mediaUrl = msg.fileDetails.publicUrl;
                    fileName = msg.fileDetails.fileName || (msg.content || 'ملف');
                    fileSize = msg.fileDetails.fileSize || 0;
                    mimeType = msg.fileDetails.mimeType || '';
                  } else if (msg.mediaUrl) {
                    mediaUrl = msg.mediaUrl;
                    fileName = msg.content || 'ملف';
                  }
                  
                  // تحويل حجم الملف إلى وحدة مناسبة
                  function formatFileSize(bytes) {
                    if (bytes === 0) return '0 بايت';
                    const units = ['بايت', 'كيلوبايت', 'ميجابايت', 'جيجابايت'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + units[i];
                  }
                  
                  const formattedSize = formatFileSize(fileSize);
                %>
                
                <% if (msg.mediaType === 'image') { %>
                  <!-- عرض الصور -->
                  <% if (mediaUrl) { %>
                    <div class="message-media">
                      <img src="<%= mediaUrl %>" alt="<%= fileName %>" class="message-image" onclick="showFullScreenImage(this.src)" data-r2-key="<%= msg.fileDetails && msg.fileDetails.r2Key ? msg.fileDetails.r2Key : '' %>">
                      <% if (msg.content && msg.content.trim() !== '') { %>
                        <div class="image-caption"><%= msg.content %></div>
                      <% } %>
                    </div>
                  <% } else { %>
                    <div class="text-muted">[صورة غير متاحة]</div>
                  <% } %>
                
                <% } else if (msg.mediaType === 'video') { %>
                  <!-- عرض الفيديو -->
                  <% if (mediaUrl) { %>
                    <div class="message-media">
                      <video controls class="message-video" data-r2-key="<%= msg.fileDetails && msg.fileDetails.r2Key ? msg.fileDetails.r2Key : '' %>">
                        <source src="<%= mediaUrl %>" type="<%= mimeType || 'video/mp4' %>">
                        لا يمكن تشغيل الفيديو على متصفحك.
                      </video>
                      <% if (msg.content && msg.content.trim() !== '') { %>
                        <div class="video-caption"><%= msg.content %></div>
                      <% } %>
                    </div>
                  <% } else { %>
                    <div class="text-muted">[فيديو غير متاح]</div>
                  <% } %>
                
                <% } else if (msg.mediaType === 'audio') { %>
                  <!-- عرض الصوت -->
                  <% if (mediaUrl) { %>
                    <div class="audio-container">
                      <div class="audio-header">
                        <i class="fas fa-headphones"></i>
                        <span>تسجيل صوتي</span>
                        <% if (msg.fileDetails && msg.fileDetails.duration) { %>
                          <span class="ms-auto">
                            <%= Math.floor(msg.fileDetails.duration / 60) %>:<%= (msg.fileDetails.duration % 60).toString().padStart(2, '0') %>
                          </span>
                        <% } %>
                      </div>
                      <div class="audio-speaking">
                        <div class="audio-wave">
                          <span></span>
                          <span></span>
                          <span></span>
                          <span></span>
                          <span></span>
                          <span></span>
                        </div>
                      </div>
                      <audio controls class="audio-player" preload="metadata" data-r2-key="<%= msg.fileDetails && msg.fileDetails.r2Key ? msg.fileDetails.r2Key : '' %>">
                        <source src="<%= mediaUrl %>" type="<%= mimeType || 'audio/mpeg' %>">
                        لا يمكن تشغيل الملف الصوتي على متصفحك.
                      </audio>
                    </div>
                  <% } else { %>
                    <div class="text-muted">[ملف صوتي غير متاح]</div>
                  <% } %>
                
                <% } else if (msg.mediaType === 'document' || msg.mediaType === 'file') { %>
                  <!-- عرض المستندات والملفات -->
                  <% if (mediaUrl) { %>
                    <div class="file-attachment">
                      <% 
                        // تحديد أيقونة الملف بناءً على نوع MIME
                        let fileIcon = 'fa-file';
                        if (mimeType) {
                          if (mimeType.includes('pdf')) {
                            fileIcon = 'fa-file-pdf';
                          } else if (mimeType.includes('word') || mimeType.includes('msword') || mimeType.includes('officedocument.word')) {
                            fileIcon = 'fa-file-word';
                          } else if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) {
                            fileIcon = 'fa-file-excel';
                          } else if (mimeType.includes('presentation') || mimeType.includes('powerpoint')) {
                            fileIcon = 'fa-file-powerpoint';
                          } else if (mimeType.includes('text/')) {
                            fileIcon = 'fa-file-alt';
                          } else if (mimeType.includes('zip') || mimeType.includes('compressed')) {
                            fileIcon = 'fa-file-archive';
                          }
                        }
                      %>
                      <div class="file-icon">
                        <i class="fas <%= fileIcon %>"></i>
                      </div>
                      <div class="file-info">
                        <div class="file-name"><%= fileName %></div>
                        <div class="file-meta">
                          <span class="file-type"><%= mimeType.split('/')[1] || 'ملف' %></span>
                          <% if (fileSize > 0) { %>
                            <span class="file-size"><%= formattedSize %></span>
                          <% } %>
                        </div>
                      </div>
                      <a href="<%= mediaUrl %>" target="_blank" class="file-download" download="<%= fileName %>" data-r2-key="<%= msg.fileDetails && msg.fileDetails.r2Key ? msg.fileDetails.r2Key : '' %>">
                        <i class="fas fa-download"></i> تنزيل
                      </a>
                    </div>
                  <% } else { %>
                    <div class="text-muted">[ملف غير متاح]</div>
                  <% } %>
                
                <% } else if (msg.mediaType === 'sticker') { %>
                  <!-- عرض الملصقات -->
                  <% if (mediaUrl) { %>
                    <div class="message-media">
                      <img src="<%= mediaUrl %>" alt="ملصق" class="message-sticker" data-r2-key="<%= msg.fileDetails && msg.fileDetails.r2Key ? msg.fileDetails.r2Key : '' %>">
                    </div>
                  <% } else { %>
                    <div class="text-muted">[ملصق غير متاح]</div>
                  <% } %>

                <% } else { %>
                  <!-- أنواع وسائط أخرى غير معروفة -->
                  <div class="text-muted">[وسائط غير مدعومة: <%= msg.mediaType %>]</div>
                <% } %>
              
              <% } else { %>
                <!-- إذا كانت رسالة نصية عادية -->
                <%= msg.content %>
              <% } %>
              
              <div class="message-time">
                <%= new Date(msg.timestamp).toLocaleString('ar-LY') %>
                
                <% if (msg.direction === 'outgoing') { %>
                  <span class="message-status">
                    <% if (msg.status === 'sending') { %>
                      <i class="fas fa-clock text-secondary" title="جاري الإرسال..."></i>
                    <% } else if (msg.status === 'sent') { %>
                      <i class="fas fa-check text-silver" title="تم الإرسال"></i>
                    <% } else if (msg.status === 'delivered') { %>
                      <i class="fas fa-check-double text-silver" title="تم التسليم"></i>
                    <% } else if (msg.status === 'read') { %>
                      <i class="fas fa-check-double text-primary" title="تم القراءة"></i>
                    <% } else if (msg.status === 'failed') { %>
                      <i class="fas fa-exclamation-triangle text-danger" title="فشل الإرسال"></i>
                    <% } %>
                  </span>
                <% } %>
              </div>
            </div>
            
            <!-- عرض التفاعلات على الرسالة -->
            <% if (msg.reactions && msg.reactions.length > 0) { %>
              <div class="message-reactions">
                <% msg.reactions.forEach(function(reaction) { %>
                  <span class="reaction-emoji" title="تفاعل من <%= reaction.sender %>">
                    <%= reaction.emoji %>
                  </span>
                <% }); %>
              </div>
            <% } %>
            
            <!-- قائمة خيارات الرسالة -->
            <div class="message-actions">
              <button type="button" class="btn btn-sm text-muted message-action-btn reaction-btn" title="تفاعل" onclick="window.showReactionPicker('<%= msg._id %>', '<%= msg.externalMessageId %>', this)">
                <i class="far fa-smile"></i>
              </button>
              <button type="button" class="btn btn-sm text-muted message-action-btn reply-btn" 
                      data-message-id="<%= msg._id %>" 
                      data-external-id="<%= msg.externalMessageId %>" 
                      title="رد" onclick="window.showReplyForm('<%= msg._id %>', '<%= msg.externalMessageId %>', this.closest('.message'))">
                <i class="fas fa-reply"></i>
              </button>
            </div>
          </div>
          <div class="clear-both"></div>
          
          <% if (index < messages.length - 1 && 
                  new Date(messages[index+1].timestamp) - new Date(msg.timestamp) > 3600000) { %>
            <div class="message-internal-note text-muted my-2" style="font-size: 0.85rem;">
              <i class="fas fa-clock me-1"></i>
              مرت <%= Math.round((new Date(messages[index+1].timestamp) - new Date(msg.timestamp)) / 3600000) %> ساعة
            </div>
          <% } %>
        <% }) %>
      <% } else { %>
        <div class="text-center text-muted py-3">
          <i class="fas fa-comment-dots mb-3" style="font-size: 3rem; opacity: 0.2;"></i>
          <p>لا توجد رسائل في هذه المحادثة.</p>
        </div>
      <% } %>
    </div>
  </div>
  
  <!-- نموذج إرسال الرد (إذا كانت المحادثة غير مغلقة) -->
  <% if (conversation.status !== 'closed') { %>
    <!-- النموذج مع الاعتماد على دالة sendReply المتوفرة من ملف conversation-utils.js -->
    <form id="replyForm" class="mt-3" onsubmit="window.sendReply(event)">
      <input type="hidden" id="conversationId" value="<%= conversation._id %>">
      <div class="mb-3">
        <label for="replyMessage" class="form-label">إرسال رد</label>
        <textarea class="form-control" id="replyMessage" name="content"
                  rows="3" required placeholder="اكتب رسالتك... (Enter للإرسال)" 
                  onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); window.sendReply(event); }"></textarea>
      </div>
      <div class="d-flex justify-content-between align-items-center">
        <span class="sending-indicator" id="sendingIndicator" style="display: none;">
          <i class="fas fa-circle-notch fa-spin"></i> جاري الإرسال...
        </span>
        <button type="button" class="btn btn-outline-secondary" onclick="document.getElementById('replyMessage').value = ''">مسح</button>
        <button type="submit" class="btn btn-primary" id="sendButton">
          <i class="fas fa-paper-plane me-1"></i> إرسال
        </button>
      </div>
    </form>
  <% } else { %>
    <div class="alert alert-secondary mt-3">
      <i class="fas fa-lock me-1"></i>
      المحادثة مغلقة، لا يمكن الرد.
    </div>
  <% } %>

<!-- إضافة حاوية عرض الصور بالحجم الكامل -->
<div class="fullscreen-overlay" id="fullscreenOverlay" onclick="hideFullScreenImage()">
  <div class="close-fullscreen">
    <i class="fas fa-times"></i>
  </div>
  <img src="" alt="صورة مكبرة" class="fullscreen-image" id="fullscreenImage">
</div>

<script>
  // دوال لعرض وإخفاء الصور بالحجم الكامل
  function showFullScreenImage(src) {
    const overlay = document.getElementById('fullscreenOverlay');
    const image = document.getElementById('fullscreenImage');
    image.src = src;
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // منع انتشار الحدث عند النقر على الصورة نفسها
    image.onclick = function(e) {
      e.stopPropagation();
    };
  }
  
  function hideFullScreenImage() {
    const overlay = document.getElementById('fullscreenOverlay');
    overlay.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
  
  // إضافة مستمع أحداث للمشغلات الصوتية
  document.addEventListener('DOMContentLoaded', function() {
    const audioPlayers = document.querySelectorAll('.audio-player');
    
    audioPlayers.forEach(player => {
      const waveContainer = player.closest('.audio-container').querySelector('.audio-wave');
      
      player.addEventListener('play', function() {
        // إيقاف تشغيل جميع المشغلات الأخرى
        audioPlayers.forEach(p => {
          if (p !== player && !p.paused) {
            p.pause();
          }
        });
        
        // تحريك موجات الصوت عند التشغيل
        waveContainer.classList.add('active');
      });
      
      player.addEventListener('pause', function() {
        // إيقاف حركة موجات الصوت عند التوقف
        waveContainer.classList.remove('active');
      });
      
      player.addEventListener('ended', function() {
        // إيقاف حركة موجات الصوت عند الانتهاء
        waveContainer.classList.remove('active');
      });
    });
  });
</script>