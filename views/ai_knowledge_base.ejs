<!DOCTYPE html>
<html lang="ar">
<head>
  <%- include('partials/_head') %>
  <title>إدارة قاعدة المعرفة للذكاء الاصطناعي</title>
  <style>
    body {
      background-color: #f8f9fa;
    }
    .container {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 20px;
      color: #3c4b64;
    }
    .form-label {
      font-weight: bold;
    }
    .form-text {
      margin-top: 5px;
      font-size: 0.85rem;
    }
    .btn-ai {
      background-color: #6f42c1;
      color: white;
    }
    .btn-ai:hover {
      background-color: #5a32a3;
      color: white;
    }
    .knowledge-item {
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    .knowledge-item:hover {
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .knowledge-title {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 10px;
    }
    .knowledge-content {
      white-space: pre-line;
      max-height: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 10px;
    }
    .knowledge-meta {
      display: flex;
      justify-content: space-between;
      color: #6c757d;
      font-size: 0.85rem;
    }
    .knowledge-keywords {
      margin-top: 10px;
    }
    .keyword-badge {
      display: inline-block;
      background-color: #e9ecef;
      padding: 5px 10px;
      margin: 3px;
      border-radius: 15px;
      font-size: 0.8rem;
    }
    .tab-pane {
      padding: 20px 0;
    }
    #content {
      min-height: 200px;
    }
    #keywords {
      height: 100px;
    }
    .filters {
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
    }
    .priority-icon {
      margin-right: 5px;
    }
    .priority-high {
      color: #dc3545;
    }
    .priority-medium {
      color: #fd7e14;
    }
    .priority-low {
      color: #28a745;
    }
  </style>
</head>
<body>
  <%- include('partials/_header') %>

  <div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1><i class="fas fa-book"></i> إدارة قاعدة المعرفة للذكاء الاصطناعي</h1>
      <div>
        <a href="/settings/ai-detailed-settings" class="btn btn-secondary">
          <i class="fas fa-arrow-right"></i> العودة لإعدادات الذكاء الاصطناعي
        </a>
      </div>
    </div>

    <% if (locals.flashMessages && flashMessages.error) { %>
      <div class="alert alert-danger"><%= flashMessages.error %></div>
    <% } %>
    <% if (locals.flashMessages && flashMessages.success) { %>
      <div class="alert alert-success"><%= flashMessages.success %></div>
    <% } %>

    <!-- تبويبات لفصل العرض والإضافة -->
    <ul class="nav nav-tabs" id="knowledgeBaseTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse" type="button" role="tab">
          <i class="fas fa-list"></i> عرض البيانات
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button" role="tab">
          <i class="fas fa-plus"></i> إضافة معلومة جديدة
        </button>
      </li>
    </ul>

    <div class="tab-content" id="knowledgeBaseTabsContent">
      <!-- تبويب عرض البيانات -->
      <div class="tab-pane fade show active" id="browse" role="tabpanel">
        <div class="filters">
          <div class="row">
            <div class="col-md-4">
              <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="ابحث عن معلومات...">
              </div>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="categoryFilter">
                <option value="">جميع التصنيفات</option>
                <% if (locals.categories) { %>
                  <% categories.forEach(category => { %>
                    <option value="<%= category %>"><%= category %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>
            <div class="col-md-3">
              <select class="form-select" id="priorityFilter">
                <option value="">جميع مستويات الأهمية</option>
                <option value="high">أهمية عالية (8-10)</option>
                <option value="medium">أهمية متوسطة (4-7)</option>
                <option value="low">أهمية منخفضة (1-3)</option>
              </select>
            </div>
            <div class="col-md-2">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="activeFilter" checked>
                <label class="form-check-label" for="activeFilter">النشطة فقط</label>
              </div>
            </div>
          </div>
        </div>

        <!-- قائمة البيانات -->
        <div id="knowledgeList">
          <% if (locals.knowledgeItems && knowledgeItems.length > 0) { %>
            <% knowledgeItems.forEach(item => { %>
              <div class="knowledge-item">
                <div class="d-flex justify-content-between">
                  <div class="knowledge-title">
                    <% if (item.priority >= 8) { %>
                      <span class="priority-icon priority-high"><i class="fas fa-fire"></i></span>
                    <% } else if (item.priority >= 4) { %>
                      <span class="priority-icon priority-medium"><i class="fas fa-arrow-up"></i></span>
                    <% } else { %>
                      <span class="priority-icon priority-low"><i class="fas fa-arrow-down"></i></span>
                    <% } %>
                    <%= item.title %>
                  </div>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="dropdownMenuButton<%= item._id %>" data-bs-toggle="dropdown" aria-expanded="false">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton<%= item._id %>">
                      <li><a class="dropdown-item edit-item" href="#" data-id="<%= item._id %>"><i class="fas fa-edit"></i> تعديل</a></li>
                      <li><a class="dropdown-item toggle-status" href="#" data-id="<%= item._id %>" data-status="<%= item.isActive %>">
                        <% if (item.isActive) { %>
                          <i class="fas fa-times-circle"></i> تعطيل
                        <% } else { %>
                          <i class="fas fa-check-circle"></i> تفعيل
                        <% } %>
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item delete-item text-danger" href="#" data-id="<%= item._id %>"><i class="fas fa-trash"></i> حذف</a></li>
                    </ul>
                  </div>
                </div>
                <div class="knowledge-content"><%= item.content %></div>
                <div class="knowledge-meta">
                  <span><i class="fas fa-tag"></i> <%= item.category %></span>
                  <span><i class="fas fa-star"></i> الأهمية: <%= item.priority %>/10</span>
                  <span>
                    <% if (item.isActive) { %>
                      <i class="fas fa-check-circle text-success"></i> نشط
                    <% } else { %>
                      <i class="fas fa-times-circle text-danger"></i> معطل
                    <% } %>
                  </span>
                </div>
                <% if (item.keywords && item.keywords.length > 0) { %>
                  <div class="knowledge-keywords">
                    <% item.keywords.forEach(keyword => { %>
                      <span class="keyword-badge"><%= keyword %></span>
                    <% }) %>
                  </div>
                <% } %>
              </div>
            <% }) %>
          <% } else { %>
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> لم يتم العثور على أي معلومات في قاعدة المعرفة. يمكنك إضافة معلومات جديدة من خلال تبويب "إضافة معلومة جديدة".
            </div>
          <% } %>
        </div>
      </div>

      <!-- تبويب إضافة معلومة جديدة -->
      <div class="tab-pane fade" id="add" role="tabpanel">
        <form id="knowledgeForm" action="/settings/ai-knowledge-base" method="POST">
          <input type="hidden" name="_id" id="itemId">
          
          <div class="row mb-3 mt-4">
            <div class="col-md-12">
              <label for="title" class="form-label">عنوان المعلومة أو السؤال <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="title" name="title" required>
              <div class="form-text">أدخل عنواناً واضحاً يُعبر عن المعلومة أو السؤال الذي سيُجاب عنه.</div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-12">
              <label for="content" class="form-label">المحتوى <span class="text-danger">*</span></label>
              <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
              <div class="form-text">أدخل المعلومات التفصيلية أو الإجابة على السؤال. يمكن استخدام الأسلوب المباشر ليسهل على الذكاء الاصطناعي استخدام هذه المعلومات.</div>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="keywords" class="form-label">الكلمات المفتاحية</label>
              <textarea class="form-control" id="keywords" name="keywords"></textarea>
              <div class="form-text">أدخل كلمات مفتاحية مفصولة بسطور جديدة. ستساعد هذه الكلمات الذكاء الاصطناعي على العثور على المعلومة المناسبة.</div>
            </div>
            <div class="col-md-6">
              <div class="row">
                <div class="col-md-6">
                  <label for="category" class="form-label">التصنيف</label>
                  <input type="text" class="form-control" id="category" name="category" list="categoriesList" value="عام">
                  <datalist id="categoriesList">
                    <option value="عام">
                    <option value="خدمات العملاء">
                    <option value="منتجات">
                    <option value="دعم فني">
                    <option value="محاسبة">
                    <option value="أسئلة متكررة">
                  </datalist>
                </div>
                <div class="col-md-6">
                  <label for="priority" class="form-label">الأهمية (1-10)</label>
                  <input type="range" class="form-range" id="priority" name="priority" min="1" max="10" value="5">
                  <div class="d-flex justify-content-between">
                    <div>1 (أقل)</div>
                    <div id="priorityValue">5</div>
                    <div>10 (أكثر)</div>
                  </div>
                </div>
              </div>
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="isActive" name="isActive" checked>
                <label class="form-check-label" for="isActive">
                  تفعيل هذه المعلومة (متاحة للاستخدام بواسطة الذكاء الاصطناعي)
                </label>
              </div>
            </div>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="button" id="resetForm" class="btn btn-outline-secondary">
              <i class="fas fa-undo"></i> إعادة ضبط النموذج
            </button>
            <button type="submit" class="btn btn-ai">
              <i class="fas fa-save"></i> <span id="submitButtonText">حفظ المعلومة</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- نافذة تأكيد الحذف -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">تأكيد الحذف</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
        </div>
        <div class="modal-body">
          هل أنت متأكد من رغبتك في حذف هذه المعلومة بشكل نهائي؟ لا يمكن التراجع عن هذا الإجراء.
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
          <button type="button" id="confirmDelete" class="btn btn-danger">تأكيد الحذف</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // تهيئة القوائم المنسدلة إذا كان كائن bootstrap متاحاً
      function initDropdowns() {
        try {
          if (typeof bootstrap !== 'undefined') {
            var dropdownElementList = [].slice.call(document.querySelectorAll('.dropdown-toggle'));
            dropdownElementList.forEach(function (dropdownToggleEl) {
              new bootstrap.Dropdown(dropdownToggleEl);
            });
          } else {
            // طريقة يدوية باستخدام JavaScript النقي
            console.warn('تعذر تهيئة القوائم المنسدلة: bootstrap غير متاح، استخدام الطريقة اليدوية');
            
            // إضافة معالج للنقر يدوياً
            document.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
              toggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // إغلاق جميع القوائم المنسدلة المفتوحة الأخرى أولاً
                document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
                  if (menu !== this.nextElementSibling) {
                    menu.classList.remove('show');
                  }
                });
                
                // تبديل القائمة المنسدلة الحالية
                var menu = this.nextElementSibling;
                if (menu && menu.classList.contains('dropdown-menu')) {
                  menu.classList.toggle('show');
                }
              });
            });
            
            // إغلاق القوائم المنسدلة عند النقر خارجها
            document.addEventListener('click', function(e) {
              var dropdowns = document.querySelectorAll('.dropdown-menu.show');
              dropdowns.forEach(function(dropdown) {
                if (!dropdown.contains(e.target) && 
                    !dropdown.previousElementSibling.contains(e.target)) {
                  dropdown.classList.remove('show');
                }
              });
            });
          }
        } catch (error) {
          console.error('خطأ في تهيئة القوائم المنسدلة:', error);
          
          // الحل الاحتياطي في حالة حدوث خطأ
          try {
            // نفس الطريقة اليدوية كما في فرع else
            document.querySelectorAll('.dropdown-toggle').forEach(function(toggle) {
              toggle.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                var menu = this.nextElementSibling;
                if (menu && menu.classList.contains('dropdown-menu')) {
                  menu.classList.toggle('show');
                }
              });
            });
          } catch (fallbackError) {
            console.error('فشل الحل الاحتياطي:', fallbackError);
          }
        }
      }
      
      // تهيئة القوائم المنسدلة عند تحميل الصفحة
      initDropdowns();
      
      // تحديث قيمة مؤشر الأهمية عند التغيير
      const priorityInput = document.getElementById('priority');
      const priorityValue = document.getElementById('priorityValue');
      priorityInput.addEventListener('input', function() {
        priorityValue.textContent = this.value;
      });
      
      // مسح النموذج
      document.getElementById('resetForm').addEventListener('click', function() {
        document.getElementById('knowledgeForm').reset();
        document.getElementById('itemId').value = '';
        document.getElementById('submitButtonText').textContent = 'حفظ المعلومة';
        priorityValue.textContent = '5';
      });
      
      // إضافة معالج حدث للنموذج
      document.getElementById('knowledgeForm').addEventListener('submit', function(e) {
        // التحقق من وجود عنوان ومحتوى (إلزامي)
        const title = document.getElementById('title').value.trim();
        const content = document.getElementById('content').value.trim();
        
        if (!title || !content) {
          e.preventDefault();
          alert('يرجى ملء جميع الحقول المطلوبة (العنوان والمحتوى)');
          return false;
        }
        
        // إذا كان كل شيء صحيحًا، سيتم إرسال النموذج
        return true;
      });
      
      // تفعيل التبويبات يدويًا للتأكد من عملها
      document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('click', function(e) {
          e.preventDefault();
          const targetId = this.getAttribute('data-bs-target');
          
          // إزالة الفئة النشطة من جميع علامات التبويب
          document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
          });
          
          // إزالة الفئات النشطة والظاهرة من جميع محتويات التبويب
          document.querySelectorAll('.tab-pane').forEach(pane => {
            pane.classList.remove('active', 'show');
          });
          
          // إضافة الفئة النشطة للتبويب المختار
          this.classList.add('active');
          
          // إظهار محتوى التبويب المستهدف
          const targetPane = document.querySelector(targetId);
          if (targetPane) {
            targetPane.classList.add('active', 'show');
          }
        });
      });
      
      // إضافة مستمعات أحداث للعناصر الأولية
      attachEventListeners();
      
      // منطق البحث والتصفية
      const searchInput = document.getElementById('searchInput');
      const categoryFilter = document.getElementById('categoryFilter');
      const priorityFilter = document.getElementById('priorityFilter');
      const activeFilter = document.getElementById('activeFilter');
      
      // إضافة مستمعي أحداث لعناصر التصفية
      [searchInput, categoryFilter, priorityFilter, activeFilter].forEach(element => {
        element.addEventListener('input', filterItems);
      });
      
      function filterItems() {
        // جمع معايير البحث
        const searchQuery = searchInput.value.trim().toLowerCase();
        const categoryValue = categoryFilter.value;
        const priorityValue = priorityFilter.value;
        const activeValue = activeFilter.checked;
        
        // إرسال طلب Ajax للبحث
        const queryParams = new URLSearchParams({
          query: searchQuery,
          category: categoryValue,
          priority: priorityValue,
          active: activeValue
        });
        
        fetch(`/settings/ai-knowledge-base/search?${queryParams}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // تحديث قائمة العناصر في واجهة المستخدم
              updateKnowledgeList(data.results);
            } else {
              console.error('خطأ في البحث:', data.message);
            }
          })
          .catch(error => {
            console.error('خطأ في إرسال طلب البحث:', error);
          });
      }
      
      // دالة لتحديث قائمة العناصر في واجهة المستخدم
      function updateKnowledgeList(items) {
        const knowledgeList = document.getElementById('knowledgeList');
        
        // مسح القائمة الحالية
        knowledgeList.innerHTML = '';
        
        if (items.length === 0) {
          knowledgeList.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle"></i> لم يتم العثور على أي معلومات تطابق معايير البحث.
            </div>
          `;
          return;
        }
        
        // إضافة العناصر الجديدة
        items.forEach(item => {
          const priorityIcon = item.priority >= 8 
            ? '<span class="priority-icon priority-high"><i class="fas fa-fire"></i></span>'
            : item.priority >= 4 
              ? '<span class="priority-icon priority-medium"><i class="fas fa-arrow-up"></i></span>'
              : '<span class="priority-icon priority-low"><i class="fas fa-arrow-down"></i></span>';
          
          const statusAction = item.isActive 
            ? '<i class="fas fa-times-circle"></i> تعطيل'
            : '<i class="fas fa-check-circle"></i> تفعيل';
          
          const keywordsBadges = item.keywords && item.keywords.length > 0
            ? item.keywords.map(keyword => `<span class="keyword-badge">${keyword}</span>`).join('')
            : '';
          
          const itemHtml = `
            <div class="knowledge-item">
              <div class="d-flex justify-content-between">
                <div class="knowledge-title">
                  ${priorityIcon}
                  ${item.title}
                </div>
                <div class="dropdown">
                  <button class="btn btn-sm btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item edit-item" href="#" data-id="${item._id}"><i class="fas fa-edit"></i> تعديل</a></li>
                    <li><a class="dropdown-item toggle-status" href="#" data-id="${item._id}" data-status="${item.isActive}">
                      ${statusAction}
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item delete-item text-danger" href="#" data-id="${item._id}"><i class="fas fa-trash"></i> حذف</a></li>
                  </ul>
                </div>
              </div>
              <div class="knowledge-content">${item.content}</div>
              <div class="knowledge-meta">
                <span><i class="fas fa-tag"></i> ${item.category}</span>
                <span><i class="fas fa-star"></i> الأهمية: ${item.priority}/10</span>
                <span>
                  ${item.isActive 
                    ? '<i class="fas fa-check-circle text-success"></i> نشط'
                    : '<i class="fas fa-times-circle text-danger"></i> معطل'}
                </span>
              </div>
              ${keywordsBadges ? `<div class="knowledge-keywords">${keywordsBadges}</div>` : ''}
            </div>
          `;
          
          knowledgeList.innerHTML += itemHtml;
        });
        
        // إعادة إضافة مستمعي الأحداث للعناصر الجديدة وتهيئة القوائم المنسدلة
        attachEventListeners();
        
        // تهيئة القوائم المنسدلة الجديدة
        initDropdowns();
      }
      
      // منطق تأكيد الحذف
      let itemToDelete = null;
      
      // دالة لإعادة إضافة مستمعي الأحداث بعد تحديث القائمة
      function attachEventListeners() {
        // إضافة مستمعي أحداث للأزرار
        document.querySelectorAll('.edit-item').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const itemId = this.getAttribute('data-id');
            
            // إرسال طلب Ajax لجلب بيانات العنصر
            fetch(`/settings/ai-knowledge-base/item/${itemId}`)
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // ملء النموذج بالبيانات
                  const item = data.item;
                  document.getElementById('itemId').value = item._id;
                  document.getElementById('title').value = item.title;
                  document.getElementById('content').value = item.content;
                  document.getElementById('keywords').value = item.keywords;
                  document.getElementById('category').value = item.category;
                  document.getElementById('priority').value = item.priority;
                  document.getElementById('priorityValue').textContent = item.priority;
                  document.getElementById('isActive').checked = item.isActive;
                  document.getElementById('submitButtonText').textContent = 'تحديث المعلومة';
                  
                  // تبديل التبويب إلى نموذج الإضافة
                  document.getElementById('add-tab').click();
                } else {
                  alert('حدث خطأ أثناء تحميل بيانات العنصر');
                }
              })
              .catch(error => {
                console.error('خطأ في جلب بيانات العنصر:', error);
                alert('حدث خطأ أثناء تحميل بيانات العنصر');
              });
          });
        });
        
        document.querySelectorAll('.delete-item').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            itemToDelete = this.getAttribute('data-id');
            
            // عرض نافذة التأكيد
            if (typeof bootstrap !== 'undefined') {
              const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
              deleteModal.show();
            } else {
              // وسيلة بديلة لعرض مربع الحوار
              if (confirm('هل أنت متأكد من رغبتك في حذف هذه المعلومة بشكل نهائي؟ لا يمكن التراجع عن هذا الإجراء.')) {
                window.location.href = `/settings/ai-knowledge-base/delete/${itemToDelete}`;
              }
            }
          });
        });
        
        document.querySelectorAll('.toggle-status').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const itemId = this.getAttribute('data-id');
            window.location.href = `/settings/ai-knowledge-base/toggle/${itemId}`;
          });
        });
      }
      
      // حذف العنصر عند تأكيد الحذف
      const confirmDeleteButton = document.getElementById('confirmDelete');
      if (confirmDeleteButton) {
        confirmDeleteButton.addEventListener('click', function() {
          if (itemToDelete) {
            // إرسال طلب حذف إلى الخادم
            window.location.href = `/settings/ai-knowledge-base/delete/${itemToDelete}`;
          }
        });
      }
    });
  </script>
</body>
</html> 